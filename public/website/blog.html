<!DOCTYPE html>
<html lang='en'>

<head>
  <meta class="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>Somleng | Blog</title>
  <link rel='stylesheet' href='css/style.min.css' />
  <link rel='stylesheet' href='css/custom.css' />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-dark.min.css">
  <link rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.css" />
  <link rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/toolbar/prism-toolbar.min.css" />

  <!-- favicon -->
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
  <link rel="manifest" href="site.webmanifest">
  <link rel="mask-icon" href="safari-pinned-tab.svg" color="#06d19c">
  <meta name="msapplication-TileColor" content="#6c63ff">
  <meta name="theme-color" content="#6C63FF">
</head>

<body>
  <!-- navbar -->
  <div class="navbar navbar--extended">
    <nav class="nav__mobile"></nav>
    <div class="container">
      <div class="navbar__inner">
        <a href="index.html" class="navbar__logo"><img src="./images/somleng_logo.png" class="step__image"
            height="75px"></a>
        <nav class="navbar__menu">
          <li><a href="docs.html">Documentation</a></li>
          <li><a href="open_source.html">Open Source</a></li>
          <li><a href="case_studies.html">Case Studies</a></li>
          <li><a href="blog.html">Blog</a></li>
        </nav>
        <div class="navbar__menu-mob"><a href="" id='toggle'><svg role="img" xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 448 512">
              <path fill="currentColor"
                d="M16 132h416c8.837 0 16-7.163 16-16V76c0-8.837-7.163-16-16-16H16C7.163 60 0 67.163 0 76v40c0 8.837 7.163 16 16 16zm0 160h416c8.837 0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837 0-16 7.163-16 16v40c0 8.837 7.163 16 16 16zm0 160h416c8.837 0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837 0-16 7.163-16 16v40c0 8.837 7.163 16 16 16z"
                class=""></path>
            </svg></a></div>
      </div>
    </div>
  </div>
  <!-- Hero unit -->
  <div class="page__header">
    <div class="hero__overlay hero__overlay--gradient"></div>
    <div class="hero__mask"></div>
    <div class="page__header__inner">
      <div class="container">
        <div class="page__header__content">
          <div class="page__header__content__inner" id='navConverter'>
            <h1 class="page__header__title">Blog</h1>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Page content -->
  <div class="page">
    <div class="container">
      <div class="page__inner">
        <div class="page__menu">
          <ul class="vMenu">
            <li><a href="#open-source-ai-powered-voice">September 12, 2024 - Implementing AI-Powered Voice at Somleng: A
                Technical Deep Dive</a></li>
            <li><a href="#infrastructure-at-somleng">December 15, 2023 - Infrastructure @ Somleng</a></li>
            <li><a href="#from-cambodia-to-laos-by-motorbike-to-setup-an-early-warning-system">September 2, 2023 - From
                Cambodia to Laos by Motorbike to setup an Early Warning System</a></li>
            <li><a href="#introducing-programmable-sms">January 27, 2023 - Introducing Programmable SMS</a></li>
            <li><a href="#introducing-diy-programmable-voice">October 14, 2022 - Introducing DIY Programmable Voice</a>
            </li>
            <li><a href="#be-your-own-twilio">June 10, 2022 - Be your own Twilio</a></li>
            <li><a href="#the-somleng-story">June 9, 2022 - The Somleng Story</a></li>
          </ul>
        </div>

        <div class="page__main">
          <div class="text-container">

            <div id="open-source-ai-powered-voice">
              <h2 class="page__main__title">
                Implementing AI-Powered Voice at Somleng: A Technical Deep Dive
              </h2>
              <h5>
                September 12, 2024
              </h5>

              <img src="./images/blog-open-source-ai-powered-voice.png" class="expanded__image">

              <p>
                Many AI voice systems, such as <a href="https://www.retellai.com/" class="link" target="_blank">Retell
                  AI</a>
                and <a href="https://vocode.dev/" class="link" target="_blank">Vocode</a> are built on top of Twilio.
                While Twilio is an excellent platform for rapid development, building an AI voice business solely on
                top of it comes with significant risks such as deplatforming and prohibitive costs.
              </p>

              <p>
                Somleng addresses these risks by offering an open-source alternative, giving businesses the freedom to
                self-host or work with lower-cost providers. Since Somleng offers full compatibility with the Twilio
                API, AI-powered voice systems built on Twilio can
                easily transition to Somleng without requiring significant changes to their existing codebase or
                architecture. This enables businesses to easily transition to a more customizable and cost-effective
                open-source alternative, without having to overhaul their existing Twilio-based workflows.
              </p>

              <p>
                In this post, we'll walk you through the technical journey of integrating AI into Somleng's voice
                platformâ€”combining key architectural decisions, the challenges we faced and the solutions we developed
                to overcome them.
              </p>

              <h3>
                Background: Twilio's &lt;Connect&gt; Verb and &lt;Stream&gt; noun
              </h3>

              <p>
                Twilio's <a href="https://www.twilio.com/docs/voice/media-streams#bidirectional-media-streams"
                  target="_blank" class="link"><code></code>&lt;Stream&gt;</a> noun,
                used within the <a href="https://www.twilio.com/docs/voice/twiml/connect" target="_blank"
                  class="link"><code>&lt;Connect&gt;</code></a> verb, is a set of <a
                  href="https://www.twilio.com/docs/voice/twiml" target="_blank" class="link">TwiML&trade;</a>
                instructions which enables
                real-time streaming of voice data to external systems for AI processing. It allows live audio from a
                call to be streamed over WebSockets to AI-driven platforms, where speech recognition, natural language
                processing, or machine learning algorithms can analyze the conversation in real time. This makes it
                ideal for building voice-powered AI applications like interactive voice response (IVR), real-time
                transcription, sentiment analysis, and intelligent customer support bots, enhancing the call experience
                with AI capabilities. Most existing AI Voice systems, such as <a href="https://www.retellai.com/"
                  class="link" target="_blank">Retell
                  AI</a>
                and <a href="https://vocode.dev/" class="link" target="_blank">Vocode</a> return the following TwiML
                instructions to initiate a connection with Twilio.
              </p>

              <p>
              <pre><code class="language-xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;Response&gt;
  &lt;Connect&gt;
    &lt;Stream url=&quot;wss://example.com/audiostream&quot; /&gt;
  &lt;/Connect&gt;
&lt;/Response&gt;</code></pre>
              </p>

              <p>
                After Twilio parses this TwiML document, it opens a Websockets connection to the AI voice system by
                connecting to the
                URL
                provided in the
                <code>url</code> attribute of the <code>&lt;Stream&gt;</code> noun. Audio is Base64 encoded, included
                in a
                <a href="https://www.twilio.com/docs/voice/media-streams/websocket-messages" class="link"
                  target="_blank">Twilio defined Websocket message</a>
                and sent
                bi-directionally between Twilio and the AI voice system. Below is an example of a
                <a href="https://www.twilio.com/docs/voice/media-streams/websocket-messages#media-messages" class="link"
                  target="_blank">Media message</a>.
              </p>

              <p>
              <pre><code class="language-json">{
  &quot;event&quot;: &quot;media&quot;,
  &quot;sequenceNumber&quot;: &quot;3&quot;,
  &quot;media&quot;: {
    &quot;track&quot;: &quot;outbound&quot;,
    &quot;chunk&quot;: &quot;1&quot;,
    &quot;timestamp&quot;: &quot;5&quot;,
    &quot;payload&quot;: &quot;no+JhoaJjpz...&quot;
  } ,
  &quot;streamSid&quot;: &quot;MZXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX&quot;
}</code></pre>
              </p>
              <p>
                Twilio receives websockets messages sent from the AI voice system over the websockets connection and
                returns audio to
                the caller, while the AI Voice system
                receives websockets messages from Twilio to interperate audio from the caller. See below:
              </p>
              <p>
                <img src="./images/blog-open-source-ai-powered-voice-twilio-connect-sequence-diagram.png">
              </p>

              <h3>
                How Somleng handles incoming calls
              </h3>

              <p>
                When you make a call to Twilio a bunch of stuff happens behind the scenes which allows developers to
                programmatically control the call using TwiML&trade;. Twilio encapsulates this logic into a black box.
                In this section we'll open up the black box and do a bit of a deep dive into how Somleng handles this
                process. We'll then build on this knowledge to explain how we handle the &lt;Connect&gt; verb.
              </p>

              <img src="./images/blog-open-source-ai-powered-voice-somleng-incoming-call-sequence-diagram.png">

              <p>
                The diagram above is a high-level overview of how incoming calls are handled by Somleng explained in
                more detail below:
              <ol>
                <li>
                  Alice makes a call to 999. For simplicity let's assume she called using a SIP phone registered to
                  Somleng. She could have also called over the PSTN to carrier which is connected to Somleng. In either
                  case, the call
                  reaches the Gateway (part of the <a href="https://github.com/somleng/somleng-switch" class="link"
                    target="_blank">SomlengSWITCH project</a>) which is running an <a href="https://opensips.org/"
                    class="link" target="_blank">OpenSIPS</a> SIP
                  Proxy.
                </li>
                <li>
                  The Gateway is responsible for load balancing the call to the appropriate <a
                    href="https://github.com/signalwire/freeswitch" class="link" target="_blank">FreeSWITCH</a> task. It
                  picks a
                  task based on Alice's location and forwards it accordingly.
                </li>
                <li>
                  FreeSWITCH hands the call over to Somleng Switch (also part of the <a
                    href="https://github.com/somleng/somleng-switch" class="link" target="_blank">SomlengSWITCH
                    project</a>) for controlling the call.
                </li>
                <li>
                  Somleng Switch makes an internal call to the <a href="https://github.com/somleng/somleng" class="link"
                    target="_blank">Somleng API</a> with the details of the call including Alice's number, the callee's
                  number (999) and the IP address of Alice's SIP phone.
                </li>
                <li>
                  Using this information, the Somleng API returns the TwiML endpoint associated with the callee's
                  number (999). This endpoint is pre-configured in Somleng by the application developer.
                </li>
                <li>
                  Somleng Switch makes a HTTP request to the TwiML endpoint.
                </li>
                <li>
                  The TwiML endpoint returns TwiML. In this example let's assume it returns the following:

                  <pre><code class="language-xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;Response&gt;
  &lt;Say&gt;Hello World&lt;&lt;/Say&gt;
&lt;/Response&gt;
</code></pre>
                </li>
                <li>
                  Somleng Switch processes the TwiML instructions.
                </li>
                <li>
                  Somleng Switch instructs the FreeSWITCH task to play &quot;Hello World&quot; from the TwiML
                  instructions.
                </li>
                <li>
                  FreeSWITCH sends RTP Media to Alice who hears the response &quot;Hello World&quot;.
                </li>
              </ol>
              </p>

              <h3>
                Introducing the &lt;Connect&gt; verb
              </h3>

              <p>
                Now that we have a high-level overview of how Somleng handles incoming calls, let's take a look at
                introducing the &lt;Connect&gt; verb.
              </p>

              <img src="./images/blog-open-source-ai-powered-voice-somleng-connect-sequence-diagram.png">

              <p>
                The diagram above shows what happens when we introduce the &lt;Connect&gt; verb.
                Note that steps 1-6 are the same as in the previous section and we have just
                replaced the Customer App with the AI voice system. Let's explore what happens from step 7 in more
                detail below:
              </p>

              <p>
              <ol start="7">
                <li>
                  The AI voice system returns the following TwiML:

                  <pre><code class="language-xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;Response&gt;
  &lt;Connect&gt;
    &lt;Stream url=&quot;wss://openvoice.ai&quot; /&gt;
  &lt;/Connect&gt;
&lt;/Response&gt;</code></pre>
                </li>
                <li>
                  Somleng Switch processes the TwiML instructions.
                </li>
                <li>
                  Somleng Switch instructs the FreeSWITCH task to open a Websocket connection to
                  <code>wss://openvoice.ai</code>
                </li>
                <li>
                  The FreeSWITCH task establishes a Websocket connection to the AI Voice System
                  at <code>wss://openvoice.ai</code> and sends
                  the <code>connected</code> message followed by the <code>start</code> message.
                  <pre><code class="language-json">{
  &quot;event&quot;: &quot;connected&quot;,
  &quot;protocol&quot;: &quot;Call&quot;,
  &quot;version&quot;: &quot;1.0.0&quot;
}</code></pre>
                  <pre><code class="language-json">{
  &quot;event&quot;: &quot;start&quot;,
  &quot;sequenceNumber&quot;: &quot;1&quot;,
  &quot;start&quot;: {
    &quot;accountSid&quot;: &quot;ACXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX&quot;,
    &quot;streamSid&quot;: &quot;MZXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX&quot;,
    &quot;callSid&quot;: &quot;CAXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX&quot;,
    &quot;tracks&quot;: [ &quot;inbound&quot; ],
    &quot;mediaFormat&quot;: {
      &quot;encoding&quot;: &quot;audio/x-mulaw&quot;,
      &quot;sampleRate&quot;: 8000,
      &quot;channels&quot;: 1
    },
    &quot;customParameters&quot;: {
      &quot;FirstName&quot;: &quot;Jane&quot;,
      &quot;LastName&quot;: &quot;Doe&quot;,
      &quot;RemoteParty&quot;: &quot;Bob&quot;,
    },
  },
  &quot;streamSid&quot;: &quot;MZXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX&quot;
}</code></pre>
                </li>
                <li>
                  The AI Voice System sends <code>media</code> messages to the FreeSWITCH task via the Websockets
                  connection such as:
                  <pre><code class="language-json">{
  &quot;event&quot;: &quot;media&quot;,
  &quot;sequenceNumber&quot;: &quot;3&quot;,
  &quot;media&quot;: {
    &quot;track&quot;: &quot;outbound&quot;,
    &quot;chunk&quot;: &quot;1&quot;,
    &quot;timestamp&quot;: &quot;5&quot;,
    &quot;payload&quot;: &quot;no+JhoaJjpz...&quot;
  },
  &quot;streamSid&quot;: &quot;MZXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX&quot;
}</code></pre>
                </li>
                <li>
                  The FreeSWITCH task decodes and buffers the audio received from the AI voice system then sends it back
                  to Alice.
                </li>
                <li>
                  Alice responds to the audio received.
                </li>
                <li>
                  The FreeSWITCH task encodes the received audio as a <code>media</code> message and sends it to the AI
                  voice
                  system over the Websockets connection.
                  <pre><code class="language-json">{
  &quot;event&quot;: &quot;media&quot;,
  &quot;sequenceNumber&quot;: &quot;135&quot;,
  &quot;media&quot;: {
    &quot;track&quot;: &quot;outbound&quot;,
    &quot;chunk&quot;: &quot;1&quot;,
    &quot;timestamp&quot;: &quot;10&quot;,
    &quot;payload&quot;: &quot;no+JhoaJjpz...&quot;
  },
  &quot;streamSid&quot;: &quot;MZXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX&quot;
}</code></pre>
                </li>
              </ol>
              </p>

              <h3>
                Writing a FreeSWITCH module: mod_twilio_stream
              </h3>

              <p>
                In order to handle steps 10 through 14 above we got some help from an engineer at one of our customers
                <a href="https://nucleus.com/" target="_blank" class="link">Nucleus</a> to write a FreeSWITCH module
                called
                <a href="https://github.com/somleng/somleng-switch/tree/develop/components/freeswitch/src/mod/mod_twilio_stream"
                  target="_blank" class="link">mod_twilio_stream</a>. The module was based on the <a
                  href="https://github.com/drachtio/drachtio-freeswitch-modules/tree/main/modules/mod_audio_fork"
                  target="_blank" class="link">mod_audio_fork</a> by
                <a href="https://drachtio.org/" target="_blank" class="link">Drachtio</a>, and adds support for <a
                  href="https://www.twilio.com/docs/voice/media-streams/websocket-messages" class="link"
                  target="_blank">Twilio defined Websocket messages</a>. The implementation details of the module is
                beyond the
                scope of this article, but the source code is available in the
                <a href="https://github.com/somleng/somleng-switch/tree/develop/components/freeswitch/src/mod/mod_twilio_stream"
                  target="_blank" class="link">Somleng Switch Github repository</a>.
              </p>

              <h3>
                Invoking mod_twilio_stream from Somleng Switch
              </h3>

              <p>
                In order to handle steps 8 and 9 we needed to figure out a way to invoke the new
                <a href="https://github.com/somleng/somleng-switch/tree/develop/components/freeswitch/src/mod/mod_twilio_stream"
                  target="_blank" class="link">mod_twilio_stream</a>
                module with the websockets URL after parsing the TwiML received in step 7.
                Somleng Switch uses <a href="https://github.com/somleng/adhearsion" target="_blank"
                  class="link">Adhearsion</a> which is a Ruby based voice application development framework to handle
                APIs such as playing audio files, recording calls and handing text-to-speech (TTS). Under the hood,
                Adhearsion uses
                <a href="https://developer.signalwire.com/freeswitch/FreeSWITCH-Explained/Modules/mod_rayo_3375450/"
                  target="_blank" class="link">mod_rayo</a> to invoke commands on FreeSWITCH. Digging through the
                <a href="https://github.com/signalwire/freeswitch/blob/master/src/mod/event_handlers/mod_rayo/mod_rayo.c#L3014"
                  target="_blank" class="link">mod_rayo source code</a>, we found an API for executing arbitrary API
                commands on FreeSWITCH. We can then make use of this API allows us to invoke <a
                  href="https://github.com/somleng/somleng-switch/tree/develop/components/freeswitch/src/mod/mod_twilio_stream"
                  target="_blank" class="link">mod_twilio_stream</a> with the required dynamic arguments such as the
                websockets URL. The actual implementation details of this is beyond the scope of this article, but the
                source code is available in the <a
                  href="https://github.com/somleng/somleng-switch/blob/develop/components/app/app/workflows/execute_connect.rb"
                  target="_blank" class="link">Somleng Switch Github repository</a>.
              </p>

              <h3>
                Handling stream events
              </h3>

              <p>
                The <a href="https://www.twilio.com/docs/voice/media-streams#bidirectional-media-streams"
                  target="_blank" class="link">&lt;Connect&gt; verb specification</a> states that:
              <blockquote>
                &quot;To start a bidirectional Media Stream, use &lt;Connect&gt;
                &lt;Stream&gt;. These TwiML instructions block subsequent TwiML instructions unless the WebSocket
                connection
                is disconnected.&quot;
              </blockquote>
              Therefore, we need to add code in order to handle events coming from <a
                href="https://github.com/somleng/somleng-switch/tree/develop/components/freeswitch/src/mod/mod_twilio_stream"
                target="_blank" class="link">mod_twilio_stream</a> such as stream disconnect events.
              </p>

              <p>
                <a href="https://github.com/somleng/somleng-switch/tree/develop/components/freeswitch_event_logger"
                  target="_blank" class="link">FreeSWITCH event logger</a>
                is a sidecar container written in <a href="https://go.dev/" target="_blank" class="link">Go</a> that
                runs alongside
                Somleng Switch and FreeSWITCH. Its main task is to log
                <a href="https://developer.signalwire.com/freeswitch/FreeSWITCH-Explained/Introduction/Event-System/Event-List_7143557/#heartbeat"
                  target="_blank" class="link">FreeSWITCH heartbeat events</a> which is used to auto-scale FreeSWITCH
                tasks based on
                the
                <code>Session-Count</code> attribute.
              </p>

              <p>
                We can also use it to parse custom events from <a
                  href="https://github.com/somleng/somleng-switch/tree/develop/components/freeswitch/src/mod/mod_twilio_stream"
                  target="_blank" class="link">mod_twilio_stream</a> and publish them to a
                <a href="https://redis.io/" target="_blank" class="link">Redis</a> channel for the audio
                stream. Somleng Switch subscribes to this channel in order to handle the events.
              </p>

              <img src="./images/blog-open-source-ai-powered-voice-somleng-switch-event-handling.png">

              <p>
                The diagram above shows how events are handled.
              <ol>
                <li>
                  Somleng Switch uses Redis pub/sub to subscribe to events on a given stream using a unique stream ID.
                </li>
                <li>
                  Somleng Switch invokes <a
                    href="https://github.com/somleng/somleng-switch/tree/develop/components/freeswitch/src/mod/mod_twilio_stream"
                    target="_blank" class="link">mod_twilio_stream</a>.
                </li>
                <li>
                  FreeSWITCH Event Logger sidecar container receives a custom event emitted from <a
                    href="https://github.com/somleng/somleng-switch/tree/develop/components/freeswitch/src/mod/mod_twilio_stream"
                    target="_blank" class="link">mod_twilio_stream</a>.
                </li>
                <li>
                  FreeSWITCH Event Logger publishes the event to Redis.
                </li>
                <li>
                  Somleng Switch receives the event.
                </li>
                <li>
                  Somleng Switch handles the event.
                </li>
              </ol>
              </p>

              <h3>
                Interrupting the AI with live call updates
              </h3>

              <p>
                In order to modify an in-progress call which is connected to the AI, we had to implement our own version
                of
                <a href="https://www.twilio.com/docs/voice/api/call-resource#update-a-call-resource" target="_blank"
                  class="link">Twilio's Update a Call resource API</a>. This API allows you to modify and in-progress
                call by providing a new set of <a href="https://www.twilio.com/docs/voice/twiml" target="_blank"
                  class="link">TwiML</a> instructions or a new URL providing TwiML instructions for the call.
              </p>

              <p>
                In order to implement this feature we also make use of Redis pub/sub to publish call update events. More
                details about the implementation can be found in the <a
                  href="https://github.com/somleng/somleng-switch/blob/develop/components/app/app/web/api.rb"
                  target="_blank" class="link">Somleng Switch Github repository</a>.
              </p>

              <img src="./images/blog-open-source-ai-powered-voice-somleng-live-call-updates.png">

              <p>
                The diagram above shows how live call updates are handled.
              <ol>
                <li>
                  AI Voice System sends POST request to Somleng's <a
                    href="https://www.somleng.org/docs/twilio_api/#4-update-a-call-in-progress-with-twiml"
                    target="_blank" class="link">Update a call resource API</a>.
                </li>
                <li>
                  Somleng API sends an internal API request to Somleng Switch with the new TwiML instructions.
                </li>
                <li>
                  Somleng Switch publishes the call update event to Redis.
                </li>
                <li>
                  Somleng Switch receives the call update event.
                </li>
                <li>
                  Somleng Switch the stop command on <a
                    href="https://github.com/somleng/somleng-switch/tree/develop/components/freeswitch/src/mod/mod_twilio_stream"
                    target="_blank" class="link">mod_twilio_stream</a>.
                </li>
                <li>
                  FreeSWITCH sends a <a
                    href="https://www.twilio.com/docs/voice/media-streams/websocket-messages#stop-message"
                    target="_blank" class="link">stop message</a> to the AI Voice System disconnects the websocket
                  connection.
                  <pre><code class="language-json">{
  &quot;event&quot;: &quot;stop&quot;,
  &quot;sequenceNumber&quot;: &quot;5&quot;,
  &quot;stop&quot;: {
    &quot;accountSid&quot;: &quot;ACXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX&quot;,
      &quot;callSid&quot;: &quot;CAXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX&quot;
    },
  &quot;streamSid&quot;: &quot;MZXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX&quot;
}</code></pre>

                </li>
                <li>
                  Somleng Switch handles the new TwiML.
                </li>
              </ol>
              </p>

              <h3>
                Integration Testing with SIPp
              </h3>

              <p>
                In order to test the complete setup we wrote some integration tests with <a
                  href="https://sipp.sourceforge.net/" target="_blank" class="link">SIPp</a> and <a
                  href="https://docs.docker.com/compose/" target="_blank" class="link">docker compose</a>. These
                tests are run as part of the
                <a href="https://github.com/somleng/somleng-switch/blob/develop/.github/workflows/integration_tests.yml"
                  target="_blank" class="link">Somleng Switch integration
                  suite</a>
                on Github Actions.
              </p>

              <img src="./images/blog-open-source-ai-powered-voice-somleng-sipp-integration-testing.png">

              <p>
                The sequence diagram below above shows how this <a
                  href="https://github.com/somleng/somleng-switch/blob/develop/components/testing/tests/public_gateway/connect_stream_test.sh"
                  target="_blank" class="link">integration test</a> works and is explained in more detail
                below. Note that SIPp, WSS Server and File Server are all running on the one docker container in the
                <a href="https://github.com/somleng/somleng-switch/blob/develop/docker-compose.yml" target="_blank"
                  class="link">docker compose file</a>, but are shown separately in the diagram for clarity.
              <ol>
                <li>
                  Start <a href="https://www.tcpdump.org/" target="_blank" class="link">tcpdump</a>, on the testing
                  server and run it in the
                  background. Start SIPp in UAC mode with a custom
                  <a href="https://github.com/somleng/somleng-switch/blob/develop/components/testing/scenarios/uac_connect.xml"
                    target="_blank" class="link">connect stream test scenario</a>.
                </li>

                <li>
                  SIPp sends a SIP Invite to the gateway container running OpenSIPS.
                </li>

                <li>
                  The gateway forwards the SIP Invite to the container running FreeSWITCH.
                </li>

                <li>
                  Somleng Switch picks up the call and gets a mock TwiML response from the
                  <a href="https://github.com/somleng/somleng-switch/blob/develop/components/app/lib/call_platform/fake_client.rb"
                    target="_blank" class="link">fake client</a> which would normally connect to the Somleng API. We're
                  not interested in testing the connection to
                  Somleng API in this test so this part is mocked out. The fake TwiML response contains the following:
                  <pre><code class="language-xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;Response&gt;
  &lt;Connect&gt;
    &lt;Stream url=&quot;ws://testing:3001&quot; /&gt;
  &lt;/Connect&gt;
  &lt;Play&gt;http://testing:8000/scenarios/files/tone.wav&lt;/Play&gt;
&lt;/Response&gt;</code></pre>. We will assert that the Play verb was executed later in the test.
                </li>

                <li>
                  Somleng Switch processes the first verb in the TwiML document namely the &lt;Connect&gt; verb.
                </li>

                <li>
                  FreeSWITCH responds with a 200 OK to the Gateway container.
                </li>

                <li>
                  The Gateway container responds with a 200 OK to the test server running SIPp.
                </li>

                <li>
                  Somleng Switch invokes mod_twilio_stream on FreeSWITCH with the URL from the &lt;Connect&gt; verb
                  obtained from
                  step 4.
                </li>

                <li>
                  FreeSWITCH establishes a Websockets connection to the Websockets Server running on port 3001.
                </li>

                <li>
                  The SIPp UAC scenario plays media which is sent to the FreeSWITCH via RTP.
                </li>

                <li>
                  mod_twilio_stream encodes the audio and sends it to the Websockets server as a
                  <a href="https://www.twilio.com/docs/voice/media-streams/websocket-messages#media-messages"
                    class="link" target="_blank">Twilio Websockets Media message</a>. The Websockets server decodes the
                  message and stores it in a buffer.
                </li>

                <li>
                  The SIPp UAC scenario plays a DTMF tone which is sent to the FreeSWITCH via RTP.
                </li>

                <li>
                  mod_twilio_stream encodes the DTMF tone and sends it to the Websockets server as a
                  <a href="https://www.twilio.com/docs/voice/media-streams/websocket-messages#dtmf-message" class="link"
                    target="_blank">Twilio Websockets DTMF message</a>. The Websockets server
                  receives the message and stops recording the received audio.
                </li>

                <li>
                  The Websockets server starts sending back the previously stored audio
                  encoded in <a href="https://www.twilio.com/docs/voice/media-streams/websocket-messages#media-messages"
                    class="link" target="_blank">Twilio Websockets Media messages</a>.
                </li>

                <li>
                  mod_twilio_stream decodes the received audio and sends it back to the caller (SIPp UAC) as RTP.
                </li>

                <li>
                  mod_twilio_stream sends a <a
                    href="https://www.twilio.com/docs/voice/media-streams/websocket-messages#mark-message" class="link"
                    target="_blank">Twilio Websockets Mark message</a> when it's done playing the audio back to the
                  caller.
                </li>

                <li>
                  The Websockets server receives the <a
                    href="https://www.twilio.com/docs/voice/media-streams/websocket-messages#mark-message" class="link"
                    target="_blank">Twilio Websockets Mark message</a> and closes the websockets connection.
                </li>

                <li>
                  Somleng Switch receives a close event from mod_twilio_stream.
                </li>

                <li>
                  Since the Websockets connection has been closed by the remote side, Somleng Switch continues
                  processing the TwiML in the document from step 4. Now it processes the &lt;Play&gt; verb which will
                  play
                  an audio file back to the caller.
                </li>

                <li>
                  Somleng Switch invokes the play_audio command on FreeSWITCH with the URL obtained from the TwiML
                  document.
                </li>

                <li>
                  FreeSWITCH fetches the audio file from the File Server which is also running in the test server docker
                  container.
                </li>

                <li>
                  The File Server responds with the audio file.
                </li>

                <li>
                  FreeSWITCH plays the audio file back to the caller (SIPp UAC) as RTP.
                </li>

                <li>
                  Somleng Switch receives an event from FreeSWITCH that it's done playing the audio, and continues with
                  the next TwiML verb in the document.
                </li>

                <li>
                  Since there are no more TwiML verbs to process Somleng Switch invokes the hangup command on
                  FreeSWITCH.
                </li>

                <li>
                  FreeSWITCH sends a SIP BYE to the Gateway container.
                </li>

                <li>
                  The Gateway container sends a SIP Bye to the caller (SIPp UAC).
                </li>

                <li>
                  The SIPp scenario is finished and the test continues, stopping tcpdump.
                </li>
              </ol>
              </p>

              <p>
                After we have captured the a trace with tcpdump we extract the audio using <a href="https://tshark.dev/"
                  class="link" target="_blank">tshark</a> and <a href="https://www.ffmpeg.org/" class="link"
                  target="_blank">ffmpeg</a>. We then compare the MD5 checksum of the audio received by the Websockets
                server
                as well as the audio received by the SIPp UAC from the &lt;Play&gt; verb and compare it with the MD5
                checksum of the audio files. If the checksums match then the test passes, otherwise it fails.
              </p>
            </div>

            <div id="infrastructure-at-somleng">
              <h2 class="page__main__title">
                Infrastructure @ Somleng
              </h2>

              <h5>
                December 15, 2023
              </h5>

              <img src="./images/somleng-infrastructure-blog.png" class="expanded__image">

              <p>
                This is a technical post about how we dynamically scale our infrastructure at Somleng.
              </p>

              <h3>
                Background
              </h3>

              <p>
                Somleng is an Open Source Communications-Platform-as-a-Service (CPaaS) and
                Telco-as-a-Service (TaaS). On the CPaaS side, Somleng includes an Open Source implementation of Twilio's
                APIs for Programmable Voice and Messaging as well as a Dashboard for customers to configure their
                account, manage their credentials, configure phone numbers, manage Text-to-Speech (TTS) etc. Somleng
                supports TwiML for programming voice and messaging flows.
              </p>

              <p>
                On the TaaS side, Somleng includes a Dashboard and API for companies (aka Carriers) who want to provide
                their own branded Twilio-like service to their customers. Companies can create and manage accounts, SIP
                trunks, SMS gateways, manage customer billing etc.
              </p>

              <p>
                Somleng is being used in a variety of different use-cases around the world. For example it powers
                telehealth services in
                <a href="case_studies.html" target="_blank" class="link">Zambia and Guatemala</a>
                and the National Early Warning Systems of
                <a href="case_studies.html#early-warning-system-cambodia" target="_blank" class="link">Cambodia</a>
                and
                <a href="#from-cambodia-to-laos-by-motorbike-to-setup-an-early-warning-system" target="_blank"
                  class="link">Laos</a>.
              </p>

              <p>
                When considering the use-case for powering Early Warning Systems, an interesting problem arises. Most of
                the time the system is relatively idle, supporting only a few registration calls per minute. However in
                the case of an emergency, the system needs to be able to handle thousands of calls per minute.
              </p>

              <p>
                We don't want to run over-provisioned servers all of the time because this will make the cost
                prohibitively expensive, but we need to be able to dynamically handle high loads.
              </p>

              <h3>
                Components
              </h3>

              <h4>
                Dashboard and API
              </h4>

              <p>
                The Somleng Dashboard and API is powered by a Ruby on Rails application connected to a managed
                PostgreSQL database which manages all of the business logic. This part of the application is relatively
                easy to auto-scale by placing the application behind a layer 7 managed load balancer such as
                <a href="https://docs.aws.amazon.com/elasticloadbalancing/latest/application/introduction.html"
                  target="_blank" class="link">AWS' Application Load Balancer</a>.
              </p>
              <p>
                The load balancer routes requests to
                <a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/Welcome.html" target="_blank"
                  class="link">ECS
                  tasks</a>
                which are running an Nginx
                reverse proxy and a copy of the Rails application. Cloudwatch alarms are configured to auto-scale the
                number of tasks based on CPU usage. When a new task is in service, ECS will register the new task with
                the load balancer and start routing requests to it. Conversely when the CPU utilization drops below a
                certain threshold a task is deregistered from the load balancer and terminated thereby saving cost. This
                is a relatively standard setup common for most web applications.
              </p>

              <img src="./images/somleng-dashboard-api-infrastructure.png">
              <cite>Figure 1: Somleng Dashboard and API</cite>

              <h4>
                Somleng Switch Layer
              </h4>

              <p>
                In order to power programmable voice applications, we need to leave the application layer (layer 7)
                behind and drop down to the transport layer (level 4). There are a couple of Open Source
                communication technology platforms in the VoIP domain such as Asterisk and FreeSWITCH. At Somleng we use
                <a href="https://github.com/signalwire/freeswitch" target="_blank" class="link">FreeSWITCH</a>
                which acts as either a SIP user agent client (UAC) and SIP user agent server (UAS) depending
                on whether it is initiating a voice call or receiving a voice call.
              </p>

              <p>
                When acting as a UAC, FreeSWITCH can also be placed behind an Application Load Balancer and placed in a
                private subnet behind a
                <a href="https://docs.aws.amazon.com/vpc/latest/userguide/vpc-nat-gateway.html" target="_blank"
                  class="link">NAT
                  Gateway</a>
                as shown below:
              </p>

              <img src="./images/somleng-infrastructure-uac.png">
              <cite>Figure 2: Somleng UAC Infrastructure</cite>

              <p>
                Internal API requests are received from Somleng via an Application Load Balancer to Nginx Reverse
                Proxies running alongside FreeSWITCH instances. This architecture allows FreeSWITCH to be auto-scaled up
                and down based on CPU utilization and/or
                session
                count without having to introduce any SIP aware load balancers.
              </p>

              <p>
                There is one problem about this approach
                though which has to do with SIP and NAT. To understand this problem we need to understand a
                little bit more about the
                <a href="https://en.wikipedia.org/wiki/Session_Initiation_Protocol" target="_blank" class="link">
                  Session Initiation Protocol (SIP)</a>
                and the
                <a href="https://en.wikipedia.org/wiki/Session_Description_Protocol" target="_blank" class="link">
                  Session Description Protocol (SDP)</a>.
              </p>

              <h5>
                The SIP Via Header
              </h5>

              <p>
                In a SIP invite request, the UAC will insert a SIP Via header indicating the path taken by the request
                so far which helps in routing the responses back along the same path. Here's an example of a SIP Via
                Header:
              </p>

              <p>
              <pre><code class="language-plain">Via: SIP/2.0/UDP 10.10.1.21;branch=z9hG4bKv5jFZ8am7aZQc</code></pre>
              </p>

              <p>
                In the example above, the responses will be sent back to <code>10.10.1.21</code> at the default port
                for
                UDP <code>5060</code>.
              </p>

              <p>
                Here you can see a problem immediately with our infrastructure above. 10.10.1.21 is the IP address
                of
                the FreeSWITCH ECS task and is not publicly routable from the Internet. Therefore any responses from
                the
                UAS
                will not be received by the UAC. This is because FreeSWITCH (acting as the UAC) constructs the SIP
                header and is only aware of its own IP address and port. When the request passes through the managed
                NAT
                Gateway, it will do
                <a href="https://en.wikipedia.org/wiki/Port_address_translation" target="_blank" class="link">Port
                  Address Translation (PAT)</a>
                and change the actual IP and port of the request as
                shown below:
              </p>

              <img src="./images/somleng-infrastructure-blog-uac-behind-nat.png">
              <cite>Figure 3: UAC Behind NAT Gateway</cite>

              <p>
                To handle this situation
                <a href="https://www.ietf.org/rfc/rfc3261.txt#:~:text=18.2.1%20Receiving%20Requests" target="_blank"
                  class="link">Section 18.2.1 of RFC 3261</a>
                describes how a server must add a "received"
                parameter to the topmost Via header when it receives a request:
              </p>

              <blockquote>
                This parameter MUST contain the source address from which the packet was received.
              </blockquote>

              <p>
                This parameter was designed to assist routing of responses
                not only where NAT is involved but also where the upstream device has used a hostname rather than an
                IP
                address in the Via it inserted. The default behavior for routing of SIP responses over UDP, as
                described
                in RFC 3261, is to use address and port information embedded in the relevant Via header - the
                address is
                taken from the "received" parameter value and the port is taken from the "sent-by" component. If
                there
                is no port, it defaults to port 5060 for UDP and TCP, or port 5061 for TLS.
              </p>

              <p>
                Here's how the Via Header looks when the "received" parameter is added by the UAS:
              </p>

              <p>
              <pre><code class="language-plain">Via: SIP/2.0/UDP 10.10.1.21;received=13.250.230.15;branch=z9hG4bKv5jFZ8am7aZQc</code></pre>
              </p>

              <p>
                The UAS has added the "received" parameter which correctly corresponds to the public IP of the NAT
                gateway. However this alone is not enough. Responses from the UAS will still be sent to the port
                5060
                (default for UDP). Since this port is not mapped by the NAT gateway, responses cannot be received by
                the
                UAS.
              </p>

              <img src="./images/somleng-infrastructure-blog-uac-nat-received-parameter.png">
              <cite>Figure 4: UAC Behind NAT Gateway with "received" parameter</cite>

              <p>
                This problem was addressed in
                <a href="https://tools.ietf.org/html/rfc3581" target="_blank" class="link">RFC 3581</a>
                It describes the "rport" parameter as follows:
              </p>

              <blockquote>
                When a server compliant to this specification (which can be a proxy or UAS) receives a
                request, it examines the topmost Via header field value. If this Via header field value
                contains an "rport" parameter with no value, it MUST set the value of the parameter to
                the source port of the request. This is analogous to the way in which a server will insert
                the "received" parameter into the topmost Via header field value. In fact, the server
                MUST insert a "received" parameter containing the source IP address that the request
                came from, even if it is identical to the value of the "sent-by" component.
              </blockquote>

              <p>
                Fortunately FreeSWITCH automatically adds this empty "rport" parameter to the via parameter when it
                detects it's behind a NAT. Here's how the Via header looks with the empty "rport" parameter when
                sent
                via the UAC (FreeSWITCH):
              </p>

              <p>
              <pre><code class="language-plain">Via: SIP/2.0/UDP 10.10.1.21;rport;branch=z9hG4bKv5jFZ8am7aZQc</code></pre>
              </p>

              <p>
                And here's how the Via header looks after it has been received by the UAS:
              </p>

              <p>
              <pre><code class="language-plain">Via: SIP/2.0/UDP 10.10.1.21;received=13.250.230.15;rport=37058;branch=z9hG4bKv5jFZ8am7aZQc</code></pre>
              </p>

              <p>
                The addition of an "rport" parameter alongside the "received" parameter means that SIP responses can
                be
                passed back to the source using symmetric routing. Responses will now be sent from the UAS to
                13.250.230.15 on port 37058 which correspond to the IP address and port address mapping of the
                managed
                NAT Gateway. The NAT gateway will then map this port back to the FreeSWITCH task which is running on
                10.10.1.21.
              </p>

              <img src="./images/somleng-infrastructure-blog-uac-nat-received-rport-parameters.png">
              <cite>Figure 5: UAC Behind NAT Gateway with "received" and "rport" parameters</cite>

              <h5>
                SDP and RTP
              </h5>

              <p>
                Unfortunately this is not the end of the story.
                Inside a SIP Invite request body there's a SDP packet
                which describes multimedia communication information. Here's an truncated example from Somleng:
              </p>

              <pre><code class="language-plain line-numbers">Session Description Protocol Version (v): 0
Connection Information (c): IN IP4 13.250.230.15
Media Description, name and address (m): audio 25984 RTP/AVP 0 8 101 13
</code></pre>

              <p>
                The following line shows the media connection information:
              </p>

              <p>
              <pre><code class="language-plain">Connection Information (c): IN IP4 13.250.230.15</code></pre>
              </p>

              <p>
                The connection information part correctly uses the IP address of the NAT Gateway. This is because in
                <a href="https://github.com/somleng/somleng-switch/tree/develop/components/freeswitch/conf"
                  target="_blank" class="link">our FreeSWITCH configuration</a>
                we set the
                <code>ext-rtp-ip</code>
                parameter to the IP address of the NAT Gateway which causes
                FreeSWITCH to insert the correct value. Without this configuration FreeSWITCH would insert the
                private
                IP address of the ECS task's network interface into the SDP. However there's also an issue with the
                following line:
              </p>

              <p>
              <pre
                class="language-plain"><code>Media Description, name and address (m): audio 25984 RTP/AVP 0 8 101 13</code></pre>
              </p>

              <p>
                This line specifies the port in which the media should be sent and received from. FreeSWITCH opens
                this
                port (25984) for sending media and inserts it into the SDP. By default FreeSWITCH will select a
                random
                port in
                the range 16384-32768.
              </p>

              <p>
                However when RTP media is sent out through the NAT gateway to the UAS, the port will be translated
                and
                will no longer match the value in the SDP. This typically results in one-way audio issues because
                the
                media server on the UAS side will try to send audio back to the port specified in the SDP which
                cannot
                be reached as illustrated below:
              </p>

              <img src="./images/somleng-infrastructure-blog-rtp-nat.png">
              <cite>Figure 6: UAC Behind NAT Gateway SDP and RTP</cite>

              <p>
                In order to work around this issue, we typically require UAS/Media Servers connecting to Somleng to
                enable Symmetric RTP. Symmetric RTP means that the IP address and port pair used by an
                outbound RTP flow is reused for the inbound flow. The IP address and port are learned when the
                initial
                RTP flow is received on the UAS. The flow's source address and port are latched onto and used as the
                destination for the RTP sourced by the UAC. The IP address and port in the c line and m line
                respectively in the SDP message are ignored. This is illustrated below:
              </p>

              <img src="./images/somleng-infrastructure-blog-symmetric-rtp.png">
              <cite>Figure 7: UAC Behind NAT Gateway Symmetric RTP</cite>

              <p>
                In some cases, our customer's devices do not support symmetric RTP, or they cannot enable it. In
                these
                cases, we work around the issue by bypassing the Managed NAT Gateway and routing RTP through a 1-1
                NAT
                instance.
              </p>

              <p>
                The 1-1 NAT instance does not automatically apply PAT to outgoing packets. Instead, it will try to
                keep
                the outbound port of the client and only apply PAT if there is a conflicting port. Given that
                FreeSWITCH
                generates a random port for RTP for each session in the range 16384-32768 it should be relatively
                rare
                to see conflicts and PAT.
              </p>

              <p>
                Routing RTP through the 1-1 NAT instance means that the UAS will receive RTP packets from the port
                which
                corresponds to the value in the (m) line of the SDP. The UAS media server can therefore send RTP
                back to
                this port
                which will be routed back to the FreeSWITCH media server as illustrated below:
              </p>

              <img src="./images/somleng-infrastructure-blog-1-1-nat.png">
              <cite>Figure 8: UAC Behind 1-1 NAT Instance</cite>

              <h4>
                SIP Load Balancing
              </h4>

              <p>
                So far we have managed to get away with using off-the-shelf managed services such as an AWS
                Application
                Load Balancer and an AWS NAT Gateway to horizontally scale FreeSWITCH when used as a User Agent
                Client
                (UAC). But we also want to use FreeSWITCH as a User Agent Server (UAS) to handle inbound calls. This
                poses a new set of challenges described in the following section.
              </p>

              <p>
                Incoming SIP and RTP are sent over UDP. We want these requests to be load balanced to our FreeSWITCH
                tasks, but we cannot use the existing Application Load Balancer which operates on layer 7 (or the
                application layer of the OSI Model). AWS also has a managed layer 4

                <a href="https://docs.aws.amazon.com/elasticloadbalancing/latest/network/introduction.html"
                  target="_blank" class="link">Network Load Balancer</a>
                which can
                be used to load balance UDP, however this type of load balancer is not SIP aware. Here's what
                happens
                when we try to load balance SIP directly to the FreeSWITCH tasks using a managed Network Load
                Balancer.
              </p>

              <img src="./images/somleng-infrastructure-blog-no-proxy.png">
              <cite>Figure 9: UAS Behind Network Load Balancer</cite>

              <p>
                The non-SIP-aware Network Load Balancer, just distributes requests between the ECS tasks running
                FreeSWITCH. In the example above the SIP Invite is sent to one ECS task, but the SIP BYE is sent to
                another.
              </p>

              <p>
                In order to handle this we need a SIP-aware proxy that sits between the managed Network Load
                Balancer
                and the FreeSWITCH UAS tasks. The proxy will be able to handle incoming requests and route them to
                the
                correct FreeSWITCH task. For this we use
                <a href="https://opensips.org/" target="_blank" class="link">OpenSIPS</a>.
                OpenSIPS comes with a load balancer module which
                supports FreeSWITCH out of the box.
              </p>

              <img src="./images/somleng-infrastructure-blog-opensips-proxy.png">
              <cite>Figure 10: UAS Behind OpenSIPS Proxy</cite>

              <p>
                With an OpenSIPS proxy in place, new requests (SIP Invites) will be load balanced across the
                available
                FreeSWITCH tasks. In order to illustrate this better let's look at a complete example.
              </p>

              <img src="./images/somleng-infrastructure-blog-full-sip-invite.png">
              <cite>Figure 11: SIP Invite</cite>

              <ol>
                <li>
                  UAC (<code>10.65.104.1</code>) sends SIP Invite to the UAC's SIP Proxy
                  (<code>175.100.32.29</code>)
                </li>
                <li>
                  UAC's SIP Proxy forwards the request to the Network Load Balancer (<code>52.74.4.205</code>)
                </li>
                <li>
                  Network Load Balancer forwards the request to the OpenSIPS proxy ECS task
                  (<code>10.10.1.162</code>)
                </li>
                <li>
                  OpenSIPS proxy forwards the request to the FreeSWITCH task (<code>10.10.1.21</code>)
                </li>
              </ol>

              <p>
                When the SIP invite arrives at the OpenSIPS proxy it will add a new Record-Route header containing
                its
                own address above any existing Record-Route headers. In our setup, OpenSIPS is configured to add two
                Record-Route headers. This is known as double Record-Route headers and handles the special situation
                where the proxy receives a request on one network interface and sends it onwards using a different
                interface. In our case the request is received on by Network Load Balancer but sent out via the
                private
                IP address of the OpenSIPS ECS Task.
              </p>

              <p>
                The set of Record-Route headers describes the path through all proxy nodes. Combined with the
                Contact
                header, this provides a complete description of the upstream path that leads back to the UAC.
              </p>

              <p>
                Here's an
                example of a request containing the Record-Route headers and contact headers for a SIP Invite
                proxied to the UAS (FreeSWITCH ECS Task):
              </p>

              <pre><code class="language-plain line-numbers">Request-Line: INVITE sip:1294@52.74.4.205:5060;user=phone SIP/2.0
Message Header:
Record-Route: &lt;sip:10.10.1.162:5060;lr;did=05d.f7db99b7;r2=on&gt;
Record-Route: &lt;sip:52.74.4.205:5060;lr;did=05d.f7db99b7;r2=on&gt;
Record-Route: &lt;sip:175.100.32.29:5060;lr;transport=udp&gt;
Contact: &lt;sip:0715100860@10.65.104.1:5060;user=phone&gt;</code></pre>

              <p>
                Note the following:
              </p>

              <ul>
                <li>
                  The Request-Line contains the advertised IP address of the Network Load Balancer, which the UAC
                  knows
                  before it sends the request.
                </li>
                <li>
                  <code>10.10.1.162</code> is the internal IP address of the OpenSIPS ECS task. This Record-Route
                  header
                  is added by
                  the OpenSIPS proxy before it sends the request to the UAS.
                </li>
                <li>
                  <code>52.74.4.205</code> is the public IP address of the Network Load Balancer. This Record-Route
                  header is added by the OpenSIPS proxy before it sends the request to the UAS.
                </li>
                <li>
                  The attribute <code>r2=on</code> in the Record-Route headers indicates double Record-Route
                  headers.
                </li>
                <li>
                  <code>175.100.32.29</code> is the public IP address of the SIP proxy associated with the UAC and
                  is
                  added by the UAC's proxy.
                </li>
                <li>
                  <code>10.65.104.1</code> (in the contact header) is the internal IP address of the UAC.
                </li>
              </ul>

              <p>
                Now the UAS (FreeSWITCH ECS task) has a complete description of the path back to the UAC, but at
                this
                point the UAC doesn't have any knowledge of the path, the proxy nodes or even the address of the
                UAS. It needs to know the path too, for example when it wants to send more requests to the UAS
                within
                the current dialogue. This information is exchanged by the UAS in the response, which includes a
                complete copy of all the Record-Route headers. It also includes its own Contact header in the
                response.
                The path that the response follows is defined by the Via headers - the Record-Route headers are
                present
                in the response but do not influence its transmission path.
              </p>

              <img src="./images/somleng-infrastructure-blog-sip-response.png">
              <cite>Figure 12: SIP Response</cite>

              <ol>
                <li>
                  The UAS FreeSWITCH ECS Task (<code>10.10.1.21</code>) sends the response to the OpenSIPS proxy's
                  internal IP address (<code>10.10.1.162</code>) obtained from the received parameter in the Via
                  Header.
                </li>
                <li>
                  The OpenSIPS proxy ECS task forwards the response to the UAC's proxy via the Network Load
                  Balancer.
                  Note: Subsequent requests (e.g. upstream BYEs) are also forwarded via the Network Load Balancer.
                </li>
                <li>
                  The Network Load Balancer forwards the response to the UAC's SIP Proxy
                  (<code>175.100.32.29</code>)
                  obtained from the Via Header.
                </li>
                <li>
                  The UAC's SIP proxy forwards the response to the UAC (<code>10.65.104.1</code>) obtained from the
                  Via
                  Header.
                </li>
              </ol>

              <p>
                Here's the SIP response from the UAS:
              </p>

              <pre><code class="language-plain line-numbers">Status-Line: SIP/2.0 183 Session Progress
Message Header:
Via: SIP/2.0/UDP 52.74.4.205:5060;branch=z9hG4bK918f.3a1eef55.0;received=10.10.1.162
Via: SIP/2.0/UDP 175.100.32.29:5060;branch=z9hG4bK08B4d2dd80314813a74
Via: SIP/2.0/UDP 10.65.104.1:5065;branch=z9hG4bKqgyjqqdfz0g5zqhhysze7m0de;X-DptMsg=139
Record-Route: &lt;sip:10.10.1.162:5060;lr;did=05d.f7db99b7;r2=on&gt;
Record-Route: &lt;sip:52.74.4.205:5060;lr;did=05d.f7db99b7;r2=on&gt;
Record-Route: &lt;sip:175.100.32.29:5060;lr;transport=udp&gt;
Contact: &lt;sip:1294@10.10.1.21:5060;transport=udp&gt;</code></pre>

              <p>
                Note the following:
              </p>

              <ul>
                <li>
                  The Via Headers are used to route the response back to the UAC, the Record-Route headers are
                  present
                  but do not influence the transmission path.
                </li>
                <li>
                  <code>10.10.1.162</code> is the internal IP address of the OpenSIPS ECS task seen in the
                  "received"
                  parameter of the first
                  Via Header. This "received" parameter is used to determine the first hop back to the the OpenSIPS
                  Proxy in the
                  response, <em>not</em> the Record-Route header.
                </li>
                <li>
                  <code>10.10.1.21</code> (in the contact header) is the internal IP address of the UAS (FreeSWITCH
                  ECS
                  Task). This is set by the UAS in the response.
                </li>
              </ul>

              <p>
                So now, both the UAC and the UAS have a copy of the full set of Record-Route headers and is
                remembered
                by both endpoints. Once the dialogue is established, the proxies should not insert any more
                Record-Route
                headers after that initial transaction. Instead, all the sequential SIP requests should contain
                Route
                headers.
              </p>

              <p>
                The Route Set is used to create a set of Route headers. The sequence of these headers is important -
                the
                upstream server will invert the order, but a downstream server does not.
              </p>

              <img src="./images/somleng-infrastructure-blog-sip-bye.png">
              <cite>Figure 13: Downstream SIP Bye</cite>

              <ol>
                <li>
                  The UAC sends an in-dialog BYE directly to the UAS via the obtained via the UAS's Contact header.
                  The
                  first hop
                  is determined by the Route first Route header, which points to the UAC's Proxy
                  (<code>175.100.32.29</code>).
                </li>

                <li>
                  The UAC's Proxy
                  removes the route header and forwards the request to the next Route header which points to the
                  Network
                  Load Balancer (<code>52.74.4.205</code>).
                </li>

                <li>
                  The Network Load Balancer forwards the request to the OpenSIPS proxy ECS Task
                  (<code>10.10.1.162</code>).
                </li>

                <li>
                  The OpenSIPS proxy removes the the double Route Headers that it owns (<code>52.74.4.205</code> and
                  <code>10.10.1.162</code>) and forwards the request
                  to UAS obtained from the value in the Request-Line (<code>10.10.1.21</code>).
                </li>
              </ol>

              <p>
                Here's the downstream BYE request from the UAC.
              </p>

              <pre><code class="language-plain line-numbers">Request-Line: BYE sip:1294@10.10.1.21:5060;transport=udp SIP/2.0
Message Header:
Route: &lt;sip:175.100.32.29:5060;lr;did=7c1.f350d215;&gt;
Route: &lt;sip:52.74.4.205:5060;lr;did=7c1.f350d215;r2=on&gt;
Route: &lt;sip:10.10.1.162:5060;lr;did=7c1.f350d215;r2=on&gt;</code></pre>

              <p>
                Note the following:
              </p>

              <ul>
                <li>
                  The Request Line contains the private IP address of the FreeSWITCH ECS task
                  (<code>10.10.1.21</code>)
                  which it got from the Contact Header of the Response (see above).
                </li>
                <li>
                  When the request reaches OpenSIPS, it will strip both of the Route Headers and forward the request
                  to
                  the private IP address of the FreeSWITCH ECS task which it gets from the Request-Line.
                </li>
              </ul>

              <h4>
                Auto-scaling FreeSWITCH Tasks
              </h4>

              <p>
                So far we have discussed how we deploy FreeSWITCH behind both an Application Load Balancer (when
                acting
                as a UAC) and a SIP proxy (when acting as a UAS). This section discusses how we automatically scale
                FreeSWITCH tasks based on CPU and Session count.
              </p>

              <p>
                We use two separate
                <a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/service-autoscaling-targettracking.html"
                  target="_blank" class="link">Target Tracking scaling policies</a>
                which track both the CPU usage and session count of the FreeSWITCH tasks.
              </p>

              <img src="./images/somleng-infrastructure-blog-autoscaling.png">
              <cite>Figure 14: ECS Autoscaling</cite>

              <p>
                When a scaling policy adds a new task, a Lambda function is triggered which adds a load balancer
                target
                to the OpenSIPS load balancer table. OpenSIPS will then start load balancing SIP requests to the new
                task. When FreeSWITCH is acting as a UAC, this happens automatically when ECS registers the task
                with
                the Application Load Balancer.
              </p>

              <p>
                Similarly, when a task scales-in the Lambda function is triggered which removes the load balancer
                target
                from the OpenSIPS load balancer table. OpenSIPS then stops sending new requests to this endpoint.
                When
                FreeSWITCH is acting as a UAC, this happens automatically when ECS de-registers the task from the
                Application Load Balancer. After a specified timeout period, the task is terminated.
              </p>

              <h4>
                Open Source Infrastructure
              </h4>


              <a href="https://digitalpublicgoods.net/registry/somleng.html" target="_blank"><img
                  src="./images/dpg-badge.png" class="expanded__image"></a>

              <p>
                All of the Infrastructure described in this post is available as Terraform configuration
                files as part of our commitment to
                being 100% Open Source and a Digital Public Good. The configuration files can be found under the
                infrastructure directory in the following repositories:
              </p>

              <ol>
                <li>
                  <a href="https://github.com/somleng/somleng" target="_blank" class="link">Somleng Dashboard and
                    API</a>
                </li>
                <li>
                  <a href="https://github.com/somleng/somleng-switch" target="_blank" class="link"> Somleng
                    Switch</a>
                </li>
              </ol>
            </div>

            <div id="from-cambodia-to-laos-by-motorbike-to-setup-an-early-warning-system">
              <h2 class="page__main__title">
                From Cambodia to Laos by Motorbike to setup an Early Warning System
              </h2>
              <h5>
                September 2, 2023
              </h5>
              <img src="./images/dave-mara-boat-to-don-det.jpeg" class="expanded__image">
              <img src="./images/crossing-mekong-at-champassak.jpg" class="expanded__image">

              <p>
                In August 2023 my wife Mara and I traveled to
                <a href="https://en.wikipedia.org/wiki/Pakse" target="_blank" class="link">Pakse</a>
                in Southern Laos to help setup an Early Warning System pilot for
                one our customers
                <a href="https://www.peopleinneed.net" target="_blank" class="link">People In Need</a>.
                The Early Warning System is targeting three provinces of Southern Laos:
                <a href="https://en.wikipedia.org/wiki/Salavan_province" target="_blank" class="link">Salavan</a>,
                <a href="https://en.wikipedia.org/wiki/Champasak_province" target="_blank" class="link">Champasak</a>
                and
                <a href="https://en.wikipedia.org/wiki/Attapeu_province" target="_blank" class="link">Attapeu</a>.
              </p>

              <p>
                This blog post covers the journey to Laos and the setup of the Early Warning System through Somleng.
                If your only interested in the tech part, feel free to skip to
                <a href="#setting-up-the-early-warning-system-in-pakse" class="link">Day 4</a>.
              </p>

              <h3>
                Getting to Pakse
              </h3>

              <p>
                My wife and I live on a small farm just south of
                <a href="https://en.wikipedia.org/wiki/Phnom_Penh" target="_blank" class="link">Phnom Penh</a> in
                Cambodia.
                There are flights from Phnom Penh to
                <a href="https://en.wikipedia.org/wiki/Vientiane" target="_blank" class="link">Vientiane</a> (Capital of
                Laos), but Pakse is still around 670 km from Vientiane and the only way to get there is by bus.
                On the other hand Pakse is only around 600 km from Phnom Penh. There's a bus from Phnom Penh to Pakse
                but it takes between 13 and 15 hours which didn't sound fun.
                So we decided to put our stuff in a big black plastic bag, tie it to the back of my
                <a href="https://en.wikipedia.org/wiki/Honda_XL250" target="_blank" class="link">1993 Honda Degree</a>
                and hit the road.
              </p>

              <img src="./images/dave-mara-leaving-home-motorbike.jpeg">

              <h4>
                Day 1 - Phnom Penh to Stung Treng, Cambodia
              </h4>

              <p>
                We left home around 7:00am and headed north, crossing Kandal, Prey Veng, Kampong Cham and Kratie
                provinces and finally reaching
                <a href="https://en.wikipedia.org/wiki/Stung_Treng_province" target="_blank" class="link">Stung
                  Treng</a> around 3:00pm.
              </p>

              <img src="./images/dave-mara-stung-treng.jpeg" class="expanded__image">
              <a href="https://goo.gl/maps/AvUaTh9Rbfxd3pH19" target="_blank"><img
                  src="./images/map-phnom-penh-stung-treng.png" class="expanded__image"></a>

              <h4 id="day-2-stung-treng-cambodia-to-don-det-laos">
                Day 2 - Stung Treng, Cambodia to Don Det, Laos (Border Crossing)
              </h4>

              <p>
                The Cambodian-Laos border is around 70 km from Stung Treng city but the road is unpaved from the
                <a href="https://en.wikipedia.org/wiki/Sekong_Bridge" target="_blank" class="link">Sekong bridge</a>
                just outside of Stung Treng city all the way to the border.
                At the border on the Cambodian side there is nothing much except for a few shops where you can change
                <a href="https://en.wikipedia.org/wiki/Cambodian_riel" target="_blank" class="link">Cambodian Riel</a>
                (or presumably US Dollars) into
                <a href="https://en.wikipedia.org/wiki/Lao_kip" target="_blank" class="link">Lao Kip</a>. We actually
                did this at a money changer in Stung Treng before we left.
                Note that you will need some Lao Kip before entering Laos. There are no ATMs or money changers on the
                Laos side of the border, and nobody in Laos will accept Cambodian Riel or any other currency for that
                matter.
              </p>

              <h5>
                Crossing the Border at Trapaingkriel Border Checkpoint
              </h5>

              <p>
                If your crossing with a motorbike you'll have to go though <em>both</em> immigration and customs on the
                Cambodian side.
                The immigration official asked us for 10,000 Riel ($2.50) per passport after stamping us out. I'm sure
                this is a non-official payment
                since I've never been asked to pay when leaving Cambodia in the past. However I've lived in South East
                Asia for 15 years, (Cambodia for 11 of those)
                and I understand that immigration officials don't get paid enough to raise their families on the
                official salary, so I don't really have a problem helping them out.
              </p>

              <p>
                After you stamp out of Cambodia, you'll have to go to the customs office, where the official will check
                the paperwork for your motorbike.
                The important document that you need is the ownership paper for the Motorbike. In Cambodia this is known
                as the vehicle identification card or (áž€áž¶ážáž‚áŸ’ážšáž¸).
                Note that it doesn't matter if this document has the previous owner's name, but you must posses the
                actual card.
              </p>

              <img src="./images/motorbike-id-card-front.png" class="expanded__image">
              <img src="./images/motorbike-id-card-back.png" class="expanded__image">

              <p>
                If you don't have the paperwork for the motorcycle, the customs official may still be able to process
                the export documents, but you may have to pay between $10 and $20.
                Again, I think this is reasonable, especially if you don't have the required documents. If you stand
                there and argue, they are within their rights not to let you cross with the motorbike.
              </p>

              <p>
                Fortunately for us, when we entered customs office, the customs official instantly recognized my wife
                and I.
                He went to high school with my wife and her brother and I had met him once before in Phnom Penh.
                Needless to say, he helped fill out the export documents for us,
                and we were soon on our way to the Laos side.
              </p>

              <img src="./images/vanny-dave-mara-camboda-laos-border.jpeg">

              <h5 id="entering-laos">
                Entering Laos
              </h5>

              <p>
                There's a tiny office on the Laos side of the border before you get to the main immigration section.
                Apparently this is so called <em>vehicle immigration</em> where the Laos official
                will stamp your export paper from the Cambodian side. We had to pay 10,000 Riel (or $2.50) for this
                stamp. However this is not the document that are required to enter Laos with your motorbike.
                This is basically just a stamp for the customs official in Laos to see that the export paper from
                Cambodia has been stamped on the Laos side.
              </p>

              <p>
                Once we got to immigration on the Laos side, the immigration official, told us that we could not enter
                Laos with our motorbike and if we still wanted to purchase a Laos visa.
                At this point we were confused because we assumed that the stamp from the so called "vehicle
                immigration" was enough. At this point the immigration officer asked us to go to speak to customs for
                further
                clarification.
              </p>

              <p>
                The Lao customs official could not (or refused) to speak English with us.
                However, a local Lao guide who was at the border with another tour group, helped translate for us.
                According to the Lao customs official there's a new rule that only organized motorbike tours are allowed
                to enter Laos with a motorbike.
                The tours must have a local Lao guide and official paperwork. The Lao customs official didn't even try
                to ask us for money to get around the problem, he just
                flat out refused to let us enter with the motorbike.
              </p>

              <p>
                We decided to contact Mara's high school friend (the customs official on the Cambodian side) to see if
                he could help us on the Laos side.
                He came over to the Laos side and was also surprised about this new rule. He had been issuing paperwork
                on the Cambodian side but never had
                this problem before. He spoke with the Lao customs official, but he still didn't allow us to enter. So
                we prepared to take our motorbike back
                to the Cambodian side, leave it at the border and take a bus to Pakse.
              </p>

              <p>
                In the meantime, our Cambodian customs official friend was speaking with boss of the Lao customs
                official, and finally he came to us and said
                they would make an exception this time. If it wasn't for our friend on the Cambodian side there was no
                chance of us getting the motorbike into Laos, even with the
                correct paperwork.
              </p>

              <p>
                The Lao customs official charged us 50,000 Riel ($12.50) for the motorbike papers to enter Laos (I'm
                pretty sure this is more than the official amount) but we were
                happy to pay anyway. A Laos Tourist Visa also costs $40.
              </p>

              <img src="./images/customs-laos.png" class="expanded__image">
              <img src="./images/lao-motorbike-permission.png" class="expanded__image">

              <p>
                There is literally nothing on the Laos side of the border. No shops. No ATMs. No money changers. Just a
                road (with not much traffic). That's why if you are traveling by motorbike
                it is important to have some Lao Kip before you cross in case you need to stop to buy water or petrol or
                something.
              </p>

              <h5 id="road-to-don-det">
                Road to Don Det
              </h5>

              <a href="https://goo.gl/maps/ZgyHhAo1WBq3P2hV6" target="_blank"><img
                  src="./images/map-cambodian-laos-border-to-don-det.png"></a>

              <p>
                After entering Laos, we put asked Google maps to give us directions to
                <a href="https://en.wikipedia.org/wiki/Don_Det" target="_blank" class="link">Don Det</a>
                (part of the <a href="https://en.wikipedia.org/wiki/Si_Phan_Don" target="_blank" class="link">4,000
                  islands</a>) where we planned on staying the night.
                I don't really trust Google Maps in Cambodia and have been burnt a few times, so I double checked to see
                if the route seemed reasonable.
                I could see a bridge over the Mekong to
                <a href="https://en.wikipedia.org/wiki/Khong_Island" target="_blank" class="link">Don Khong</a>, a ferry
                to
                <a href="https://en.wikipedia.org/wiki/Don_Som" target="_blank" class="link">Don Som</a>, and finally
                another ferry to
                <a href="https://en.wikipedia.org/wiki/Don_Det" target="_blank" class="link">Don Det</a>.
                This sounded reasonable (and fun!) so we headed for our first stop Don Khong.
              </p>

              <h5>
                River crossing from Don Khong to Don Som
              </h5>

              <p>
                After crossing the bridge onto Don Khong, there's a short road to the ferry crossing. It costs 20,000
                Lao Kip (approx $1) to cross over to Don Som.
              </p>

              <iframe width="280" height="315" src="https://www.youtube.com/embed/3nUFUHXI74g"
                title="YouTube video player" frameborder="0"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                allowfullscreen></iframe>
              <iframe width="280" height="315" src="https://www.youtube.com/embed/wpKJe9zfbC4"
                title="YouTube video player" frameborder="0"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                allowfullscreen></iframe>

              <h5>
                The Don Som Road
              </h5>

              <p>
                The Don Som Road is difficult but beautiful. Basically it's just a narrow path through the rice fields.
                Along the way I
                had some issues with my chain coming off, but we eventually found a small shop selling drinks and
                doubling as a mechanic who helped fix it.
              </p>

              <iframe width="280" height="315" src="https://www.youtube.com/embed/Hdygwsa5kO8?si=IAEmgJtxlHdQESa1"
                title="YouTube video player" frameborder="0"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                allowfullscreen></iframe>
              <iframe width="280" height="315" src="https://www.youtube.com/embed/ObmabNtAB_E"
                title="YouTube video player" frameborder="0"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                allowfullscreen></iframe>
              <iframe width="280" height="315" src="https://www.youtube.com/embed/TqdHMSp8RCY"
                title="YouTube video player" frameborder="0"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                allowfullscreen></iframe>
              <iframe width="280" height="315" src="https://www.youtube.com/embed/ig3EFZCpTCY?si=q90gPb1mT0yVjBrd"
                title="YouTube video player" frameborder="0"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                allowfullscreen></iframe>

              <h5>
                Don Det and Don Khon
              </h5>

              <p>
                Don Det and Don Khon are connected by a bridge. Both islands are way more touristy than Don Som and all
                the roads are paved. We visited the
                Liphi Somphamit Waterfalls and the Old French Port and enjoyed a few beers before finding a place to
                stay on Don Khon.
              </p>

              <img src="./images/old-port-don-khon.jpg" class="expanded__image">
              <img src="./images/liphi-somphamit-waterfalls-couple.jpg" class="expanded__image">
              <img src="./images/beer-lao-don-khon.jpg" class="expanded__image">
              <img src="./images/liphi-somphamit-waterfalls.jpg" class="expanded__image">

              <h4>
                Day 3 - Don Det to Pakse
              </h4>

              <a href="https://goo.gl/maps/xdyUxyjvu9FLwQV49" target="_blank"><img
                  src="./images/map-nakasong-to-pakse.png" class="expanded__image"></a>
              <img src="./images/don-det-pier.png" class="expanded__image">

              <p>
                We left Don Det on the ferry to Nakasong which takes around 20 minutes. That's when we realized that
                actually Google Maps told us to go wrong way on the previous day.
                From Nakasong you just take the main highway 13 all the way to Pakse. Nakasong is basically the gateway
                to
                <a href="https://en.wikipedia.org/wiki/Don_Det" target="_blank" class="link">Don Det</a>
                and the
                <a href="https://en.wikipedia.org/wiki/Si_Phan_Don" target="_blank" class="link">4,000 islands</a>.
              </p>

              <p>
                Along the way we got burnt by Google Maps again while trying to find a waterfall in the Bolaven Plateau.
                After riding on a dirt track for a few kilometers
                I had issues with my chain again. We found a rubber plantation and one of the workers helped me fix the
                chain until we could find a proper mechanic.
                We decided to give up on the waterfall and head for Pakse.
              </p>

              <iframe width="280" height="315" src="https://www.youtube.com/embed/YxhkofJDAdw?si=ScPAzKdaQd6hTDef"
                title="YouTube video player" frameborder="0"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                allowfullscreen></iframe>
              <iframe width="280" height="315" src="https://www.youtube.com/embed/9umiw7nPfc4"
                title="YouTube video player" frameborder="0"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                allowfullscreen></iframe>

              <h3 id="setting-up-the-early-warning-system-in-pakse">
                Setting up the Early Warning System in Pakse
                </h5>

                <p>
                  This is the technical part of the post so feel free to skip it if your not interested!
                </p>

                <h4>
                  Background
                </h4>

                <p>
                  In order to have a better understanding about how we setup the Early Warning System in Laos, it's
                  useful to understand how it works in Cambodia.
                  Somleng is already
                  <a href="case_studies.html#early-warning-system-cambodia" target="_blank" class="link">powering the
                    National Early Warning System of Cambodia</a> in collaboration with the People In Need.
                  In this system, Somleng is connected to each of the main Mobile Network Operators as shown Figure 1
                  and Figure 2 below.
                </p>

                <h5>
                  Early Warning System Registration (Cambodia)
                </h5>

                <p>
                  Beneficiaries register to the Early Warning System by calling to 1294 and following the IVR prompts.
                </p>

                <figure>
                  <img src="./images/ews-cambodia-registration-flow.png">
                  <figcaption>Figure 1 - Early Warning System Registration (Cambodia)</figcaption>
                </figure>

                <p>
                <ol>
                  <li>
                    Beneficiaries register for the Early Warning System by calling 1294.
                  </li>
                  <li>
                    After receiving a call the Mobile Network Operators send a
                    <a href="https://en.wikipedia.org/wiki/Session_Initiation_Protocol" target="_blank" class="link">SIP
                      Invite</a> to
                    <a href="https://github.com/somleng/somleng-switch" target="_blank" class="link">SomlengSWITCH</a>.
                  </li>
                  <li>
                    SomlengSWITCH sends information about the call to
                    <a href="https://github.com/somleng/somleng" target="_blank" class="link">Somleng</a> which
                    determines the
                    <a href="docs.html#sip_trunks" target="_blank" class="link">SIP Trunk</a>,
                    <a href="docs.html#terminology" target="_blank" class="link">Carrier</a> and
                    <a href="docs.html#phone_numbers" target="_blank" class="link">Phone Number</a>.
                  </li>
                  <li>
                    The phone number 1294 is configured with a
                    <a href="docs.html#phone_numbers" target="_blank" class="link">Voice URL</a>
                    which points to
                    <a href="https://github.com/somleng/somleng-scfm" target="_blank" class="link">Somleng SCFM</a>.
                    SomlengSWITCH can now use this Voice URL to request
                    <a href="https://www.twilio.com/docs/voice/twiml" target="_blank" class="link">TwiML</a>
                    from Somleng SCFM which contains the IVR logic for registering the beneficiary. The beneficiary
                    details are stored in SCFM for future use as seen Figure 2 below.
                  </li>
                </ol>
                </p>

                <h5>
                  Early Warning System Broadcast (Cambodia)
                </h5>

                <p>
                  In case of an emergency such as a flood or other natural disaster, beneficiaries are notified via a
                  recorded message
                  delivered to their mobile phone.
                </p>

                <figure>
                  <img src="./images/ews-cambodia-broadcast-flow.png">
                  <figcaption>Figure 2 - Early Warning System Broadcast (Cambodia)</figcaption>
                </figure>

                <p>
                <ol>
                  <li>
                    A Government official logs into the Early Warning System Dashboard (powered by People In Need) and
                    creates an emergency broadcast message message.
                  </li>
                  <li>
                    The Early Warning System Dashboard uses the
                    <a href="docs/scfm" target="_blank" class="link">Somleng SCFM API</a> to create a callout and
                    populate it with beneficiaries who have
                    registered using the registration flow described above.
                  </li>
                  <li>
                    Somleng SCFM creates phone calls on Somleng using the
                    <a href="docs/twilio_api#create-a-call" target="_blank" class="link">Somleng REST API</a>
                  </li>
                  <li>
                    Somleng queues calls to <a href="https://github.com/somleng/somleng-switch" target="_blank"
                      class="link">SomlengSWITCH</a>.
                  </li>
                  <li>
                    SomlengSWITCH sends a
                    <a href="https://en.wikipedia.org/wiki/Session_Initiation_Protocol" target="_blank" class="link">SIP
                      Invite</a> to the corresponding Mobile Network Operator
                    of the beneficiary.
                  </li>
                  <li>
                    The beneficiary receives the call and listens to the recorded broadcast message.
                  </li>
                </ol>
                </p>

                <h4>
                  Laos Setup
                </h4>

                <p>
                  In order to power a pilot Early Warning System in Laos without the administrative red tape required to
                  connect to the local mobile network operators,
                  we use
                  <a href="#docs.html#client_gateway_configuration_guide" target="_blank" class="link">Somleng's Client
                    Gateway</a> feature to deliver the service while bypassing the mobile network operators.
                  Figures 3 and 4 below show how it works.
                </p>

                <h5>
                  Early Warning System Registration (Laos)
                </h5>

                <p>
                  Beneficiaries register to the Early Warning System by calling to advertised local numbers inserted in
                  the VoIP Gateway.
                </p>

                <figure>
                  <img src="./images/ews-laos-registration-flow.png">
                  <figcaption>Figure 3 - Early Warning System Registration (Laos)</figcaption>
                </figure>

                <p>
                <ol>
                  <li>
                    Beneficiaries call to advertised local numbers which is inserted into the VoIP gateway.
                  </li>
                  <li>
                    The VoIP gateway receives the call and sends a
                    <a href="https://en.wikipedia.org/wiki/Session_Initiation_Protocol" target="_blank" class="link">SIP
                      Invite</a> to
                    <a href="https://github.com/somleng/somleng-switch" target="_blank" class="link">SomlengSWITCH</a>.
                  </li>
                  <li>
                    SomlengSWITCH sends information about the call to
                    <a href="https://github.com/somleng/somleng" target="_blank" class="link">Somleng</a> which
                    determines the
                    <a href="docs.html#sip_trunks" target="_blank" class="link">SIP Trunk</a>,
                    <a href="docs.html#terminology" target="_blank" class="link">Carrier</a> and
                    <a href="docs.html#phone_numbers" target="_blank" class="link">Phone Number</a>.
                  </li>
                  <li>
                    The called number is configured with a
                    <a href="docs.html#phone_numbers" target="_blank" class="link">Voice URL</a>
                    which points to
                    <a href="https://github.com/somleng/somleng-scfm" target="_blank" class="link">Somleng SCFM</a>.
                    SomlengSWITCH can now use this Voice URL to request
                    <a href="https://www.twilio.com/docs/voice/twiml" target="_blank" class="link">TwiML</a>
                    from Somleng SCFM which contains the IVR logic for registering the beneficiary. The beneficiary
                    details are stored in SCFM for future use as seen Figure 4 below.
                  </li>
                </ol>
                </p>

                <h5>
                  Early Warning System Broadcast Flow (Laos)
                </h5>

                <p>
                  In case of an emergency such as a flood or other natural disaster, beneficiaries are notified via a
                  recorded message
                  delivered to their mobile phone.
                </p>

                <figure>
                  <img src="./images/ews-laos-broadcast-flow.png">
                  <figcaption>Figure 4 - Early Warning System Broadcast Flow (Laos)</figcaption>
                </figure>

                <p>
                <ol>
                  <li>
                    A Government official logs into the Early Warning System Dashboard (powered by People In Need) and
                    creates an emergency broadcast message message.
                  </li>
                  <li>
                    The Early Warning System Dashboard uses the
                    <a href="docs/scfm" target="_blank" class="link">Somleng SCFM API</a> to create a callout and
                    populate it with beneficiaries who have
                    registered using the registration flow described above.
                  </li>
                  <li>
                    Somleng SCFM creates phone calls on Somleng using the
                    <a href="docs/twilio_api#create-a-call" target="_blank" class="link">Somleng REST API</a>
                  </li>
                  <li>
                    Somleng queues calls to <a href="https://github.com/somleng/somleng-switch" target="_blank"
                      class="link">SomlengSWITCH</a>.
                  </li>
                  <li>
                    SomlengSWITCH sends a
                    <a href="https://en.wikipedia.org/wiki/Session_Initiation_Protocol" target="_blank" class="link">SIP
                      Invite</a> to the VoIP Gateway.
                    of the beneficiary.
                  </li>
                  <li>
                    The beneficiary receives the call and listens to the recorded broadcast message.
                  </li>
                </ol>
                </p>

                <p>
                  As you can see both the registration flow and broadcast flow for the Laos system is almost identical
                  as the Cambodian system.
                  The main point of difference being that we're replacing the mobile network operators with an
                  off-the-shelf VoIP Gateway.
                </p>

                <p>
                  There are of course some limitations of this setup such as:
                <ol>
                  <li>
                    The maximum throughput of the system is limited to the number of channels in the VoIP gateway.
                  </li>
                  <li>
                    Only full local Lao mobile numbers can be used as opposed to a single short code.
                  </li>
                  <li>
                    A local entity needs to ensure that the SIM cards are active. For example prepaid cards have enough
                    balance, and postpaid cards have their bills paid.
                  </li>
                </ol>
                </p>

                <p>
                  On the other hand, the benefit of this system, is that it can be built entirely with open source
                  software and off-the-shelf hardware.
                </p>

                <img src="./images/voip-gateway-laos-1.jpeg" class="expanded__image">
                <img src="./images/voip-gateway-laos-2.jpeg" class="expanded__image">

                <h3>
                  The Journey Home
                </h3>

                <p>
                  The rest of this blog post covers our journey back to Cambodia via the scenic route. ðŸ¤£
                </p>

                <h4>
                  Day 1 - Pakse to the Laos-Cambodian Border via Wat Phou
                </h4>

                <a href="https://goo.gl/maps/FC118vtfjwikZWpf9" target="_blank"><img
                    src="./images/map-pakse-cambodian-laos-border-via-wat-phou.png" class="expanded__image"></a>

                <p>
                  We left Pakse with the intention of making it back to Stung Treng, however we saw a sign
                  <a href="https://en.wikipedia.org/wiki/Vat_Phou" target="_blank" class="link">Wat Phou</a> around 30
                  km south of Pakse, so we decided to turn off and take a look.
                  We arrived at a small village where the ferry terminal is, but we accidentally took the wrong road
                  down to the river bank. There was a young lady with a small wooden boat
                  who gestured that she would take us across the Mekong river to Champasak town. Mara wasn't sure about
                  the safety of the boat as you'll see in the videos below. ðŸ˜‚
                </p>

                <iframe width="280" height="315" src="https://www.youtube.com/embed/ouFFGInNKbc?si=f3uIwvnBLXX-TEnC"
                  title="YouTube video player" frameborder="0"
                  allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                  allowfullscreen></iframe>
                <iframe width="280" height="315" src="https://www.youtube.com/embed/kvwGMgTWFII?si=DM2TmTZPra1-LBWn"
                  title="YouTube video player" frameborder="0"
                  allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                  allowfullscreen></iframe>
                <iframe width="280" height="315" src="https://www.youtube.com/embed/hLoOQbe-5eY?si=aq0b5Cfxo4k7nD9w"
                  title="YouTube video player" frameborder="0"
                  allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                  allowfullscreen></iframe>

                <p>
                  After making it safely across the river we rode south along the western side of the Mekong to
                  <a href="https://en.wikipedia.org/wiki/Vat_Phou" class="link" target="_blank">Wat Phou (àº§àº±àº”àºžàº¹)</a>.
                  Entrance is only 100,000 Lao Kip (approx $5) per person and it's well worth it as the temple is
                  magnificent.
                </p>

                <img src="./images/wat-phou-in-front-of-lake.jpg" class="expanded__image">
                <img src="./images/wat-phou-in-front-of-temple-doorway.jpg" class="expanded__image">
                <img src="./images/wat-phou-in-front-of-rock-face.jpg" class="expanded__image">
                <img src="./images/wat-phou-sitting-in-front-of-temple.jpg" class="expanded__image">

                <p>
                  After leaving Wat Phou, we decided to stay on the western side of the Mekong and continue heading
                  south.
                  The plan was to find a ferry back to
                  <a href="https://en.wikipedia.org/wiki/Khong_Island" target="_blank" class="link">Don Khong</a>
                  and then cross back over the same bridge that we took on
                  <a href="#road-to-don-det" target="_blank" class="link">the road to Don Det</a>.
                  The road was pretty rough but the scenery was beautiful.
                </p>

                <iframe width="280" height="315" src="https://www.youtube.com/embed/AepWrE-1QGc"
                  title="YouTube video player" frameborder="0"
                  allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                  allowfullscreen></iframe>
                <iframe width="280" height="315" src="https://www.youtube.com/embed/fMJ8UfLEtd0"
                  title="YouTube video player" frameborder="0"
                  allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                  allowfullscreen></iframe>
                <iframe width="280" height="315" src="https://www.youtube.com/embed/JI9DK1hBdI4"
                  title="YouTube video player" frameborder="0"
                  allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                  allowfullscreen></iframe>

                <p>
                  We eventually found a ferry crossing before we reached Don Khong and crossed back over to the eastern
                  side of the Mekong to the main highway and headed for the border, arriving around 5.00pm.
                </p>

                <iframe width="280" height="315" src="https://www.youtube.com/embed/-xgW-VCc7JQ"
                  title="YouTube video player" frameborder="0"
                  allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                  allowfullscreen></iframe>
                <iframe width="280" height="315" src="https://www.youtube.com/embed/vkduGPs3sL8"
                  title="YouTube video player" frameborder="0"
                  allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                  allowfullscreen></iframe>

                <p>
                  Shortly after crossing into Cambodia it started to piss down with rain.
                  Fortunately we ran into Mara's high school friend (who helped us with the Motorbike paperwork at
                  <a href="#entering-laos" target="_blank" class="link">the border on the way in</a>).
                  He convinced us not to try to ride to Stung Treng in the rain and dark and suggested that we have a
                  couple of beers with him.
                  So we did and ended up staying the night at his friend's house just near the border.
                </p>

                <img src="./images/beers-with-vanny.jpg">

                <h4>
                  Day 2 - Homeward bound via Kampong Cham
                </h4>

                <a href="https://goo.gl/maps/aFbcZ52eCin9JgN47" target="_blank"><img
                    src="./images/map-cambodian-laos-border-kampong-cham.png" class="expanded__image"></a>

                <p>
                  It rained pretty much all day, which made the journey a bit slow. We stopped in
                  <a href="https://en.wikipedia.org/wiki/Krati%C3%A9_province" target="_blank" class="link">Kratie</a>
                  for lunch, before riding along the Mekong to Kampong Cham where we spent the night before heading home
                  the next day.
                </p>

                <iframe width="280" height="315" src="https://www.youtube.com/embed/dZddQiFhbsI"
                  title="YouTube video player" frameborder="0"
                  allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                  allowfullscreen></iframe>
                <iframe width="280" height="315" src="https://www.youtube.com/embed/e1fhungS_yc"
                  title="YouTube video player" frameborder="0"
                  allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                  allowfullscreen></iframe>

                <h3>
                  Home safe
                </h3>

                <p>
                  We arrived home safe and sound. Hopefully we get the chance to visit Laos and it's beautiful people
                  again in the near future!
                </p>
            </div>

            <div id="introducing-programmable-sms">
              <h2 class="page__main__title">
                Introducing Programmable SMS
              </h2>
              <h5>
                January 27, 2023
              </h5>
              <img src="./images/undraw_message_sent_re_q2kl.svg" class="expanded__image">

              <p>
                In October 2022,
                <a href="#introducing-diy-programmable-voice" class="link">we introduced DIY programmable voice</a>,
                allowing customers to roll their own Twilio and make real calls
                through their VoIP gateways.
              </p>

              <p>Today we're excited to announce official support for SMS.</p>

              <p>
                With this new feature carriers can offer programmable SMS to their customers by
                <a href="docs.html#sms_gateway_configuration_guide" target="_blank" class="link">configuring an SMS
                  Gateway <i class="fa fa-external-link"></i></a> and connecting it to
                their existing SMS infrastructure.
              </p>

              <p>
                Individuals and organizations can also use this feature by connecting their SMS gateway to a device that
                supports SMPP, such as a
                <a href="https://en.wikipedia.org/wiki/VoIP_gateway" target="_blank" class="link">VoIP gateway <i
                    class="fa fa-external-link"></i></a> or
                <a href="https://en.wikipedia.org/wiki/SIM_box" target="_blank" class="link">SIM Box <i
                    class="fa fa-external-link"></i></a>.
              </p>

              <p>
                After the connection is configured, customers can programmatically send and receive SMS through their
                SMS gateway using the
                <a href="docs/twilio_api" target="_blank" class="link">REST API <i class="fa fa-external-link"></i></a>.
              </p>

              <p>
                Visit
                <a href="docs.html#sms_gateway_configuration_guide" target="_blank" class="link">our documentation <i
                    class="fa fa-external-link"></i></a>
                for more information on how to configure programmable SMS on Somleng.
              </p>

              <p>
                <em>
                  Note: Using SMS gateways is restricted in some countries.
                  We recommend that you check your local laws and regulations before proceeding with
                  this method.
                </em>
              </p>
            </div>


            <div id="introducing-diy-programmable-voice">
              <h2 class="page__main__title">
                Introducing DIY Programmable Voice
              </h2>
              <h5>
                October 14, 2022
              </h5>
              <img src="./images/undraw_recording_re_5xyq.svg" class="expanded__image">

              <p>
                At Somleng, one of our biggest customer bases are NGOs. One of the reasons that NGOs choose us is
                because we work with local carriers
                directly. This allows us to provide cloud communication services in new markets where it's otherwise
                unavailable, or with better quality, and
                <a href="case_studies.html#cash-assistance-programme-somalia" target="_blank" class="link">a fraction of
                  the cost of our competitors <i class="fa fa-external-link"></i></a>.
              </p>

              <p>
                Although working with local carriers improves quality and reduces costs, one of the biggest pain points
                for our customers
                is actually engaging with and arriving at a commercial agreement with a local carrier.
                Often our customers want to get something up and running quickly to prove a concept or do a pilot,
                without
                engaging with their local carrier.
              </p>

              <h4>
                Bypassing Carriers
              </h4>

              <p>
                It turns out that it's actually possible to access the local public switched telephone network (PSTN)
                without a commercial agreement with a local carrier.
                All you need is a
                <a href="https://en.wikipedia.org/wiki/VoIP_gateway" target="_blank" class="link">VoIP gateway <i
                    class="fa fa-external-link"></i></a> and one or more SIM cards.
                A VoIP gateway has interfaces to both IP networks and the PSTN and handles the bridging between them.
                One interface can be connected to the Internet and the other
                to the PSTN, via SIM card(s) inserted into the VoIP gateway.
                VoIP gateways range in size 1 from to 128 channels or more. The more channels you have the more
                concurrent calls you can support.
              </p>

              <p>
                Today we're excited to announce official support for VoIP gateways on Somleng.
              </p>

              <p>
                With this new feature customers can
                <a href="https://app.somleng.org/users/sign_up" target="_blank" class="link">sign up <i
                    class="fa fa-external-link"></i></a>
                and connect their VoIP gateway to Somleng by
                <a href="docs.html#client_gateway_configuration_guide" target="_blank" class="link">configuring a client
                  gateway connection <i class="fa fa-external-link"></i></a>.
              </p>

              <p>
                After the connection is configured, customers can programmatically make outbound calls through your VoIP
                gateway using the
                <a href="docs/twilio_api" target="_blank" class="link">REST API <i class="fa fa-external-link"></i></a>,
                and programmatically control both outbound and inbound calls via TwiML.
              </p>

              <p>
                <em>
                  Note: Using VoIP gateways is restricted in some countries.
                  We recommend that you check your local laws and regulations before proceeding with
                  this method.
                </em>
              </p>

              <h4>
                Network Providers
              </h4>

              <p>
                This new feature also opens up new business opportunities for individuals or organizations to provide
                access to the
                PSTN in their country via a VoIP gateway that they own or manage. We call this type of user a
                <a href="docs.html#network_provider" target="_blank" class="link">Network Provider <i
                    class="fa fa-external-link"></i></a>,
                and like carriers, they can also create customer accounts on Somleng.
              </p>

              <p>
                Any account that the Network Provider creates, is managed by them and has its own set of
                <a href="docs/twilio_api" target="_blank" class="link">REST API <i class="fa fa-external-link"></i></a>
                credentials and account management interface.
                A network provider can therefore onboard their own customers,
                by creating them an account and providing them with PSTN access through their VoIP gateway(s).
              </p>

              <p>
                This can be combined with our
                <a href="docs/#custom_domains" target="_blank" class="link">custom domains feature <i
                    class="fa fa-external-link"></i></a>
                feature resulting in a fully custom-branded experience for your customer.
              </p>

              <p>
                We don't yet have a way for a network provider to monetize this business flow directly on the Somleng
                platform, but it's something we will consider
                if enough users request this feature.
              </p>

              <h4>
                Stay Tuned
              </h4>

              <p>
                Currently our client gateway feature only supports Programmable Voice, but stay tuned because we're
                adding SMS support next!
              </p>
            </div>

            <div id="be-your-own-twilio">
              <h2 class="page__main__title">
                Be your own Twilio
              </h2>
              <h5>
                June 10, 2022
              </h5>
              <img src="./images/undraw_calling_re_mgft.svg" class="expanded__image">

              <p>
                Following on from our introductory blog post
                <a href="#the-somleng-story" class="link">The Somleng Story</a> in this post we'll do a deep dive into
                how local carriers can offer programmable voice to their customers via Somleng.
              </p>

              <h4>
                Why carriers should offer programmable voice to their customers?
              </h4>

              <p>
                Programmable voice has a variety of different use-cases such as:
              <ul>
                <li>
                  Alerts and Notifications - e.g. password resets, low balance alerts, bill reminders, fraud warnings.
                </li>
                <li>
                  Interactive Voice Response (IVR)
                </li>
                <li>
                  Disaster Management, mHealth <a href="case_studies.html" target="_blank" class="link">and more <i
                      class="fa fa-external-link"></i></a>.
                </li>
              </ul>
              </p>

              <p>
                Twilio has become the de-facto go-to solution for programmable voice and
                <a href="https://investors.twilio.com/news/news-details/2022/Twilio-Announces-First-Quarter-2022-Results/default.aspx#:~:text=Revenue%20of%20%24875.4%20million%20for,%25%20year%2Dover%2Dyear."
                  target="_blank" class="link">profits exorbitantly <i class="fa fa-external-link"></i></a>
                as a result. But actually local carriers can offer much
                <a href="case_studies.html#cash-assistance-programme-somalia" target="_blank" class="link">cheaper
                  pricing <i class="fa fa-external-link"></i></a>
                and better quality since they are the custodians of the network.
              </p>
              <p>
                By offering programmable voice as a solution, local carriers can share in the profits and obtain an
                advantage
                over their competitors all while protecting their own branding.
              </p>

              <h4>
                What is Somleng?
              </h4>

              <p>
                Somleng is an Open Source, white-labeled, Cloud Communications as a Service (CPaaS) solution.
                Unlike Twilio, which is a global centralized CPaaS designed for platform users directly,
                Somleng is designed for carriers and network operators.
              </p>

              <p>
                Instead of platform users signing up directly on Somleng, Carriers instead sign up
                for a Somleng carrier account and manage their own customer accounts.
              </p>
              <p>
                With the release of our new
                <a href="docs.html#custom_domains" target="_blank" class="link">custom domains <i
                    class="fa fa-external-link"></i></a>
                feature,
                a carrier can now configure their own custom domain and branding, providing a fully branded CPaaS
                solution their platform customers.
              </p>

              <p>
                Carriers can then invite their customers to their branded dashboard via their custom domain where the
                customer can manage their own account and API credentials.
                The customer can then use Somleng's REST API for programmable voice.
              </p>

              <figure>
                <img src="./images/somleng_customer_dashboard.png">
                <figcaption>Customized Somleng dashboard as viewed by a carrier customer.</figcaption>
              </figure>

              <figure>
                <img src="./images/somleng_customer_api_docs.png">
                <figcaption>Customized Somleng API docs as viewed by a carrier customer.</figcaption>
              </figure>

              <h4>
                Wrapping up
              </h4>

              <p>
                Public sign ups are currently available for carriers only.
                If you work for a carrier and are interested in trying things out please read through our
                <a href="docs.html" target="_blank" class="link">carrier documentation <i
                    class="fa fa-external-link"></i></a>,
                where you'll find link to sign up for a trial account.
              </p>
            </div>

            <div id="the-somleng-story">
              <h2 class="page__main__title">
                The Somleng Story
              </h2>
              <h5>
                June 9, 2022
              </h5>
              <img src="./images/undraw_phone_call_re_hx6a.svg" class="expanded__image">
              <p>
                For a while now, Twilio has become the king of cloud communications.
                Although there has been a few clones pop up over the years, e.g. Vonage, Message Bird, etc.
                the space has remained relatively same same. Until now...
              </p>
              <p>
                Somleng has the ambitious goal of revolutionizing the cloud communications space turning it on its head.
                We aim to take the power of cloud communications away from Big Tech's monopoly and bring it to the
                people.
                But to understand where we're going and why, it's important to understand where we've come from.
              </p>

              <h4>
                ðŸ‡°ðŸ‡­ Cambodian Dating
              </h4>

              <img src="./images/undraw_everywhere_together_re_xe5a.svg" class="expanded__image">

              <p>
                Starting back in 2012 Somleng's predecessor was a SMS and Voice powered dating service called Chibi.
                Launching in Cambodia, before the Smartphones and Facebook were ever really a thing (in Cambodia at
                least)
                subscribers would dial into a short-code and be randomly connected to another subscriber.
                Basically a chat roulette that worked over an ordinary voice call.
              </p>
              <p>
                Subscribers could also send text messages
                to their new 'friend' by simply texting to the short code. Chibi would scan the messages,
                and build up a basic profile of the subscriber, trying to determine their age, gender and location.
              </p>

              <p>
                The service was surprisingly popular, at its peak having more than 120,000 subscribers. But by 2015,
                smartphones and Facebook had taken over in Cambodia and Chibi eventually died.
              </p>

              <h4>
                ðŸ‡°ðŸ‡­ National Early Warning System
              </h4>

              <img src="./images/undraw_weather_notification_4sbo.svg" class="expanded__image">

              <p>
                Around 2016, the Royal Cambodian Government in partnership with the NGO People In Need,
                were looking for a solution for the
                <a href="case_studies.html#early-warning-system-cambodia" target="_blank" class="link">National Early
                  Warning System <i class="fa fa-external-link"></i></a>.
              </p>

              <p>
                The requirements were simple. In case of a natural disaster (such as a flood),
                a government official could record a voice message and deliver it via phone call to citizens in the
                affected areas.
              </p>

              <p>
                Programmable voice is a perfect solution to this problem. Voice messages are recorded in Khmer,
                so it doesn't require the beneficiary be literate, have a smart phone nor have access to the Internet.
                They just pick up the
                phone and listen to the information recorded by the government official.
              </p>

              <p>
                Our experience with building scalable communications platform to power Chibi
                meant that the timing was perfect for a pivot and Somleng was born.
              </p>

              <p>
                Today Somleng is still powering Cambodia's Early Warning System.
              </p>

              <h4>
                ðŸ‡ºðŸ‡³ UNICEF Innovation Fund and Digital Public Good
              </h4>

              <img src="./images/undraw_around_the_world_re_rb1p.png" class="expanded__image">

              <p>
                In 2016 Somleng was
                <a href="https://www.unicefinnovationfund.org/broadcast/updates/somleng-open-source-telephony"
                  target="_blank" class="link">among the first five companies to receive investment <i
                    class="fa fa-external-link"></i></a>
                from
                the UNICEF Innovation Fund, in order to scale Somleng to support other use-cases.
              </p>
              <p>
                Since then the UNICEF Innovation Fund been Somleng's main investor which has enabled us to grow far
                beyond
                Cambodia. Somleng is now powering cloud communications solutions <a href="case_studies.html"
                  target="_blank" class="link">across the world <i class="fa fa-external-link"></i></a>
                impacting over 250K beneficiaries across 11 different countries.
              </p>

              <p>
                Somleng was also recently made a <a href="https://digitalpublicgoods.net/registry/somleng.html"
                  target="_blank" class="link">Digital Public Good <i class="fa fa-external-link"></i></a> recognition
                that Somleng is a product that helps to create a more equitable world.
              </p>

              <h4>
                Our Vision and Roadmap
              </h4>

              <img src="./images/undraw_scrum_board_re_wk7v.svg" class="expanded__image">

              <p>
                There's a growing consensus that the Internet is too centralized controlled by too few players.
                It's no different in the cloud communications space. Big Tech controls most of the space
                and there are few options for individuals, small and medium sized companies, governments and NGOs.
              </p>

              <p>
                Somleng's vision is a world where communications are accessible to everyone.
                In order to achieve this vision we need to think outside the box and provide a solution benefits
                everyone, not just Big Tech.
              </p>

              <h4>
                Be your own Twilio
              </h4>

              <img src="./images/undraw_building_re_xfcm.svg" class="expanded__image">

              <p>
                The first step for Somleng, is to level the playing field for local carriers (for clarification a local
                carrier
                is a local telecom company, mobile network operator or aggregator).
              </p>
              <p>
                Twilio's et al. business model is based on a centralized Cloud Communications Platform as a Service
                (CPaaS). They charge an
                expensive premium (especially in emerging markets), to basically act as a middle-man between the
                platform user and the beneficiary.
              </p>

              <p>
                But what if a local carrier, who controls the network connectivity in their region or country,
                could <em>be</em> their own Twilio? They could provide a similar service to Twilio at a
                <a href="case_studies.html#cash-assistance-programme-somalia" target="_blank" class="link">fraction of
                  the cost <i class="fa fa-external-link"></i></a> by cutting them out of the flow.
              </p>
              <p>
                In addition to the reduced costs for the platform user, the local carrier can protect their own branding
                and generate
                additional revenue streams.
              </p>

              <p>
                Somleng now supports
                <a href="docs.html#custom_domains" target="_blank" class="link">custom domains <i
                    class="fa fa-external-link"></i></a>
                allowing carriers to leverage Somleng's API and Dashboard, while keeping their own branding.
                Alternatively, since Somleng is 100% open source, local carriers can always host Somleng
                on their own servers.
              </p>

              <h4>
                Be your own carrier
              </h4>

              <img src="./images/undraw_programmer_re_owql.svg" class="expanded__image">

              <p>
                While supporting local carriers is a good first step, there's still a level of centralization at the
                local carrier level.
                In other words, Somleng now provides a solution to dissipate the monopoly of cloud communications from
                Big Tech
                to local carriers, but we can still go a step further to bring the power to individuals and
                organizations directly.
              </p>

              <p>
                One of the features we'll be working on in the coming months is called "Be your own carrier".
                The idea is that any individual, business or organization can use Somleng to become a Network Provider,
                and provide the connectivity layer
                required for cloud communications, and in a future iteration, even be able to earn money from it.
              </p>

              <p>
                The idea is quite simple. Using readily available, off-the-shelf hardware such as a GSM Gateway or GSM
                Modem,
                a network provider can provide connectivity to their local mobile network and register their route with
                Somleng.
                Somleng will then route calls and SMS to/from the network provider to provide programmable voice and SMS
                to the platform user.
              </p>

              <p>
                A simple use-case for this is handling phone number verification via programmable voice.
                In order do achieve this now, you need to use a service like Twilio or Firebase.
                However with Somleng's "Be your own carrier" feature the application owner can register as a Network
                Provider,
                and their application can initiate a call via Somleng's REST API.
                The call is then routed via the network provider's hardware to the beneficiary's phone.
              </p>

              <p>
                Now that any individual or organization can <em>be</em> their own carrier by becoming a network
                provider,
                the foundations are in place for a global marketplace of network providers and local carriers.
              </p>

              <h4>
                A more equitable CPaaS Economy
              </h4>

              <img src="./images/undraw_transfer_money_re_6o1h.svg" class="expanded__image">

              <p>
                The final step in Somleng's CPaaS revolution is to leverage the global network of local carriers and
                network providers
                to provide a more equitable CPaaS economy. Local operators and network providers can make their routes
                publicly available
                and set their own prices and be compensated for every interaction that goes through their route. In
                theory this should
                create competition for who can offer the cheapest, highest quality routes.
              </p>

              <h4>
                Wrapping up
              </h4>

              <p>
                We're excited about the journey that we're on and proud to be doing things differently.
                A special thanks to the UNICEF Innovation Fund team who have supported us from the beginning.
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js">
    </script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/toolbar/prism-toolbar.min.js"></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/copy-to-clipboard/prism-copy-to-clipboard.min.js"></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
</body>

</html>
